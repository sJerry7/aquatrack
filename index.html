<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaTrack ‚Äî RO Filter AMC Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e; --surface: #111827; --surface2: #1a2235; --border: #1f2d47;
    --accent: #00d4ff; --profit: #22d3a5; --loss: #f87171; --warn: #fbbf24;
    --text: #e2e8f0; --text-dim: #64748b; --text-mid: #94a3b8;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

  /* SETUP */
  .setup-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
  .setup-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:40px; width:100%; max-width:540px; }
  .setup-card h1 { font-family:'Syne',sans-serif; font-weight:800; font-size:28px; color:var(--accent); margin-bottom:6px; }
  .setup-card p { color:var(--text-mid); font-size:14px; margin-bottom:28px; }
  .setup-step { display:flex; gap:14px; align-items:flex-start; padding:12px 0; border-bottom:1px solid var(--border); }
  .setup-step:last-child { border-bottom:none; }
  .step-num { width:28px; height:28px; border-radius:50%; background:var(--accent); color:#000; font-family:'Syne',sans-serif; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .step-text { font-size:13px; color:var(--text-mid); line-height:1.6; }
  .step-text strong { color:var(--text); }
  .step-text a { color:var(--accent); }
  .url-input-wrap { margin-top:20px; }
  .url-input-wrap label { display:block; font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); margin-bottom:8px; }
  .url-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px 14px; color:var(--text); font-family:'DM Mono',monospace; font-size:12px; outline:none; transition:border-color 0.2s; }
  .url-input:focus { border-color:var(--accent); }
  .connect-btn { width:100%; margin-top:14px; background:var(--accent); color:#000; border:none; border-radius:8px; padding:12px; font-family:'Syne',sans-serif; font-weight:700; font-size:14px; cursor:pointer; }
  .connect-btn:disabled { opacity:0.6; cursor:not-allowed; }

  /* LAYOUT */
  #appShell { display:none; }
  header { background:linear-gradient(135deg,#0a0f1e,#0d1a2e); border-bottom:1px solid var(--border); padding:14px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
  .logo { font-family:'Syne',sans-serif; font-weight:800; font-size:20px; color:var(--accent); }
  .logo span { color:var(--text); }
  .header-right { display:flex; gap:10px; align-items:center; }
  .sync-status { font-size:11px; padding:4px 10px; border-radius:20px; }
  .sync-ok { background:rgba(34,211,165,.12); color:var(--profit); }
  .sync-err { background:rgba(248,113,113,.12); color:var(--loss); }
  .sync-loading { background:rgba(0,212,255,.1); color:var(--accent); }

  /* REMINDER BANNER */
  #reminderBanner { display:none; background:rgba(251,191,36,.07); border-bottom:1px solid rgba(251,191,36,.2); padding:10px 24px; }
  .reminder-banner-inner { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .reminder-banner-title { font-family:'Syne',sans-serif; font-weight:700; color:var(--warn); font-size:13px; }
  .reminder-chips { display:flex; gap:8px; flex-wrap:wrap; flex:1; }
  .reminder-chip { background:rgba(251,191,36,.1); border:1px solid rgba(251,191,36,.25); border-radius:20px; padding:4px 12px; font-size:12px; color:var(--warn); cursor:pointer; display:flex; align-items:center; gap:6px; white-space:nowrap; }
  .reminder-chip:hover { background:rgba(251,191,36,.18); }
  .reminder-chip .days { font-weight:700; }

  .app { display:flex; height:calc(100vh - 53px); }
  /* if banner visible the app height adjusts automatically */
  .sidebar { width:300px; min-width:240px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
  .main { flex:1; overflow-y:auto; padding:24px; }

  .sidebar-top { padding:14px; border-bottom:1px solid var(--border); }
  .search-box { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:9px 12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px; outline:none; }
  .search-box:focus { border-color:var(--accent); }
  .search-box::placeholder { color:var(--text-dim); }
  .add-customer-btn { width:100%; margin-top:10px; background:var(--accent); color:#000; border:none; border-radius:8px; padding:9px; font-family:'Syne',sans-serif; font-weight:700; font-size:13px; cursor:pointer; }

  /* FILTER TABS */
  .filter-tabs { display:flex; gap:4px; margin-top:10px; background:var(--bg); border-radius:8px; padding:3px; }
  .filter-tab { flex:1; text-align:center; padding:5px 4px; font-size:11px; font-weight:700; font-family:'Syne',sans-serif; border-radius:6px; cursor:pointer; border:none; background:none; color:var(--text-dim); letter-spacing:0.3px; transition:all 0.15s; }
  .filter-tab.active { background:var(--surface); color:var(--text); box-shadow:0 1px 4px rgba(0,0,0,0.3); }
  .filter-tab.active.all { color:var(--text); }
  .filter-tab.active.amc { color:var(--accent); }
  .filter-tab.active.regular { color:var(--profit); }

  /* REGULAR CUSTOMER BADGES */
  .badge-regular { background:rgba(34,211,165,.12); color:var(--profit); }
  .badge-last-visit { background:rgba(148,163,184,.1); color:var(--text-mid); }

  .customer-list { overflow-y:auto; flex:1; }
  .customer-item { padding:13px 16px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
  .customer-item:hover { background:var(--surface2); }
  .customer-item.active { background:rgba(0,212,255,.07); border-left:3px solid var(--accent); }
  .c-name { font-family:'Syne',sans-serif; font-weight:600; font-size:14px; }
  .c-meta { font-size:12px; color:var(--text-dim); margin-top:3px; }
  .c-badges { display:flex; flex-wrap:wrap; gap:4px; margin-top:5px; }
  .c-badge { font-size:10px; font-weight:700; padding:2px 7px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; }
  .badge-active { background:rgba(34,211,165,.15); color:var(--profit); }
  .badge-expired { background:rgba(248,113,113,.15); color:var(--loss); }
  .badge-expiring { background:rgba(251,191,36,.15); color:var(--warn); }
  .badge-reminder { background:rgba(251,191,36,.2); color:var(--warn); }

  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-dim); gap:12px; text-align:center; }

  .customer-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:24px; gap:16px; flex-wrap:wrap; }
  .customer-title h2 { font-family:'Syne',sans-serif; font-weight:800; font-size:26px; }
  .customer-title p { color:var(--text-mid); margin-top:4px; font-size:13px; }

  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:24px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px; }
  .stat-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:8px; }
  .stat-value { font-family:'Syne',sans-serif; font-weight:700; font-size:22px; }
  .stat-value.profit { color:var(--profit); } .stat-value.loss { color:var(--loss); } .stat-value.neutral { color:var(--accent); }
  .stat-sub { font-size:11px; color:var(--text-dim); margin-top:4px; }

  .section { background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:20px; overflow:hidden; }
  .section-header { padding:14px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .section-title { font-family:'Syne',sans-serif; font-weight:700; font-size:14px; }

  .btn { border:none; border-radius:7px; padding:7px 14px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:500; cursor:pointer; transition:all 0.15s; }
  .btn-accent { background:var(--accent); color:#000; font-weight:700; }
  .btn-accent:hover { background:#00b8d9; }
  .btn-accent:disabled { opacity:.5; cursor:not-allowed; }
  .btn-ghost { background:var(--surface2); color:var(--text-mid); border:1px solid var(--border); }
  .btn-ghost:hover { color:var(--text); }
  .btn-danger { background:rgba(248,113,113,.1); color:var(--loss); border:1px solid rgba(248,113,113,.2); }
  .btn-sm { padding:4px 10px; font-size:11px; }
  .btn-warn { background:rgba(251,191,36,.12); color:var(--warn); border:1px solid rgba(251,191,36,.25); }
  .btn-warn:hover { background:rgba(251,191,36,.22); }
  .btn-green { background:rgba(34,211,165,.12); color:var(--profit); border:1px solid rgba(34,211,165,.25); }
  .btn-green:hover { background:rgba(34,211,165,.22); }

  /* SERVICE SCHEDULE TABLE */
  .schedule-table { width:100%; border-collapse:collapse; }
  .schedule-table th { font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); font-family:'DM Mono',monospace; padding:10px 18px; text-align:left; border-bottom:1px solid var(--border); font-weight:500; }
  .schedule-table td { padding:12px 18px; border-bottom:1px solid rgba(31,45,71,.5); font-size:13px; vertical-align:middle; }
  .schedule-table tr:last-child td { border-bottom:none; }
  .schedule-table tr:hover td { background:rgba(255,255,255,.02); }

  .sched-status { font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; }
  .sched-pending { background:rgba(0,212,255,.1); color:var(--accent); }
  .sched-due-soon { background:rgba(251,191,36,.15); color:var(--warn); }
  .sched-overdue { background:rgba(248,113,113,.15); color:var(--loss); }
  .sched-done { background:rgba(34,211,165,.12); color:var(--profit); }

  /* SERVICE HISTORY TABLE */
  .service-table { width:100%; border-collapse:collapse; }
  .service-table th { font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); font-family:'DM Mono',monospace; padding:10px 18px; text-align:left; border-bottom:1px solid var(--border); font-weight:500; }
  .service-table td { padding:12px 18px; border-bottom:1px solid rgba(31,45,71,.5); font-size:13px; }
  .service-table tr:last-child td { border-bottom:none; }
  .service-table tr:hover td { background:rgba(255,255,255,.02); }
  .service-type { font-size:10px; font-weight:700; padding:2px 8px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; }
  .type-free { background:rgba(34,211,165,.12); color:var(--profit); }
  .type-complaint { background:rgba(251,191,36,.12); color:var(--warn); }
  .type-paid { background:rgba(248,113,113,.12); color:var(--loss); }
  .amount-cell { font-family:'DM Mono',monospace; font-weight:500; }

  .comp-chips { display:flex; flex-wrap:wrap; gap:6px; }
  .comp-chip { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:3px 9px; font-size:12px; color:var(--text-mid); display:flex; align-items:center; gap:5px; }
  .comp-chip .price { font-family:'DM Mono',monospace; font-size:11px; color:var(--accent); }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:28px; width:100%; max-width:560px; max-height:90vh; overflow-y:auto; }
  .modal h3 { font-family:'Syne',sans-serif; font-weight:800; font-size:18px; margin-bottom:20px; color:var(--accent); }
  .form-group { margin-bottom:14px; }
  .form-group label { display:block; font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); margin-bottom:6px; font-weight:500; }
  .form-input, .form-select { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px; outline:none; transition:border-color 0.2s; }
  .form-input:focus, .form-select:focus { border-color:var(--accent); }
  .form-select option { background:var(--surface2); }
  .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }

  .comp-rows { display:flex; flex-direction:column; gap:8px; margin-bottom:8px; }
  .comp-row { display:flex; gap:8px; align-items:center; }
  .comp-row .form-input { flex:1; }
  .comp-row .price-input { width:110px; min-width:110px; }
  .remove-comp-btn { background:none; border:none; color:var(--loss); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; }

  /* SCHEDULE EDITOR */
  .sched-rows { display:flex; flex-direction:column; gap:10px; }
  .sched-editor-row {
    background:var(--surface2); border:1px solid var(--border); border-radius:10px;
    padding:14px; display:flex; flex-direction:column; gap:10px;
  }
  .sched-row-top { display:flex; gap:8px; align-items:center; }
  .sched-row-num { width:26px; height:26px; border-radius:50%; background:var(--accent); color:#000; font-family:'Syne',sans-serif; font-weight:700; font-size:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .sched-label-input { flex:1; }
  .sched-timing { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .sched-timing select, .sched-timing input[type=number] { background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:6px 10px; font-size:12px; outline:none; }
  .sched-timing input[type=number] { width:70px; }
  .sched-timing label { font-size:12px; color:var(--text-mid); }
  .add-sched-btn { background:none; border:1px dashed var(--border); border-radius:8px; padding:10px; color:var(--text-dim); cursor:pointer; font-size:13px; width:100%; transition:all 0.15s; }
  .add-sched-btn:hover { border-color:var(--accent); color:var(--accent); }
  .remove-sched-btn { background:none; border:none; color:var(--loss); cursor:pointer; font-size:16px; padding:2px 5px; }

  .no-data { padding:28px; text-align:center; color:var(--text-dim); font-size:13px; }
  .progress-bar-wrap { height:6px; background:var(--border); border-radius:3px; margin-top:8px; overflow:hidden; }
  .progress-bar { height:100%; border-radius:3px; }
  .amc-info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; padding:16px 18px; }
  .amc-info-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.6px; }
  .amc-info-value { font-family:'DM Mono',monospace; font-size:14px; margin-top:4px; }
  .delete-icon { cursor:pointer; opacity:0.5; }
  .delete-icon:hover { opacity:1; color:var(--loss); }

  .spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(0,212,255,.2); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; margin-right:6px; }
  @keyframes spin { to { transform:rotate(360deg); } }

  .toast { position:fixed; bottom:24px; right:24px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 18px; font-size:13px; z-index:999; box-shadow:0 8px 30px rgba(0,0,0,.4); animation:slideUp 0.3s ease; }
  @keyframes slideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:var(--surface); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  @media (max-width:900px) { .stats-row { grid-template-columns:repeat(2,1fr); } .amc-info-grid { grid-template-columns:repeat(2,1fr); } }
  @media (max-width:650px) { .app { flex-direction:column; } .sidebar { width:100%; height:auto; max-height:220px; } .stats-row { grid-template-columns:1fr 1fr; } .form-row { grid-template-columns:1fr; } }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div class="setup-screen" id="setupScreen">
  <div class="setup-card">
    <h1>üíß AquaTrack</h1>
    <p>Connect your Google Sheet to get started. All data syncs across every device in real time.</p>
    <div class="setup-steps">
      <div class="setup-step"><div class="step-num">1</div><div class="step-text">Go to <a href="https://script.google.com" target="_blank">script.google.com</a> ‚Üí Create a <strong>New Project</strong></div></div>
      <div class="setup-step"><div class="step-num">2</div><div class="step-text">Paste the <strong>Apps Script v2 code</strong> provided, update <strong>OWNER_EMAIL</strong>, and Save</div></div>
      <div class="setup-step"><div class="step-num">3</div><div class="step-text"><strong>Deploy ‚Üí New Deployment</strong> ¬∑ Type: Web App ¬∑ Execute as: Me ¬∑ Access: Anyone</div></div>
      <div class="setup-step"><div class="step-num">4</div><div class="step-text">For daily email reminders: <strong>Triggers ‚Üí Add Trigger ‚Üí dailyReminderCheck ‚Üí Day timer ‚Üí 9am</strong></div></div>
      <div class="setup-step"><div class="step-num">5</div><div class="step-text">Paste your <strong>Web App URL</strong> below and connect</div></div>
    </div>
    <div class="url-input-wrap">
      <label>Google Apps Script Web App URL</label>
      <input class="url-input" id="scriptUrlInput" type="url" placeholder="https://script.google.com/macros/s/XXXXXXX/exec">
    </div>
    <button class="connect-btn" id="connectBtn" onclick="connectSheet()">üîó Connect & Load Data</button>
    <div id="connectError" style="color:var(--loss);font-size:12px;margin-top:10px;display:none;"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="appShell">
  <header>
    <div class="logo">Aqua<span>Track</span></div>
    <div class="header-right">
      <span class="sync-status sync-ok" id="syncStatus">‚úÖ Synced</span>
      <button class="btn btn-ghost" onclick="refreshData()" style="font-size:11px;">‚ü≥ Refresh</button>
      <button class="btn btn-ghost" onclick="disconnectSheet()" style="font-size:11px;">Disconnect</button>
    </div>
  </header>

  <!-- REMINDER BANNER -->
  <div id="reminderBanner">
    <div class="reminder-banner-inner">
      <span class="reminder-banner-title">‚ö†Ô∏è Upcoming Services:</span>
      <div class="reminder-chips" id="reminderChips"></div>
    </div>
  </div>

  <div class="app">
    <div class="sidebar">
      <div class="sidebar-top">
        <input class="search-box" id="searchInput" type="text" placeholder="üîç  Search customer...">
        <button class="add-customer-btn" onclick="openAddCustomer()">+ Add New Customer</button>
        <div class="filter-tabs">
          <button class="filter-tab active all" onclick="setFilter('all',this)">All</button>
          <button class="filter-tab amc" onclick="setFilter('amc',this)">üîµ AMC</button>
          <button class="filter-tab regular" onclick="setFilter('regular',this)">üü¢ Regular</button>
        </div>
      </div>
      <div class="customer-list" id="customerList">
        <div class="no-data"><span class="spinner"></span> Loading...</div>
      </div>
    </div>
    <div class="main" id="mainContent">
      <div class="empty-state">
        <div style="font-size:48px;opacity:0.3;">üíß</div>
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div>
        <div style="max-width:260px;color:var(--text-dim);font-size:13px;">Choose a customer from the sidebar to view their AMC ledger.</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" style="display:none;" onclick="handleOverlayClick(event)">
  <div class="modal" id="modalBox"></div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let SCRIPT_URL = localStorage.getItem('aquatrack_script_url') || '';
let appData = { customers: [], nextId: 1 };
let selectedCustomerId = null;
let activeFilter = 'all'; // 'all', 'amc', 'regular'

function setFilter(type, btn) {
  activeFilter = type;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  selectedCustomerId = null;
  renderSidebar();
  document.getElementById('mainContent').innerHTML = `<div class="empty-state"><div style="font-size:48px;opacity:0.3;">üíß</div><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div></div>`;
}

// ============================================================
// INIT
// ============================================================
window.onload = () => {
  if (SCRIPT_URL) { showApp(); refreshData(); }
};

function showApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';
}

async function connectSheet() {
  const url = document.getElementById('scriptUrlInput').value.trim();
  const errEl = document.getElementById('connectError');
  errEl.style.display = 'none';
  if (!url.includes('script.google.com')) { errEl.textContent = '‚ö†Ô∏è Please paste a valid Google Apps Script URL.'; errEl.style.display = 'block'; return; }
  const btn = document.getElementById('connectBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Connecting...';
  try {
    const result = await apiCall('getAll', {}, url);
    SCRIPT_URL = url;
    localStorage.setItem('aquatrack_script_url', url);
    appData = result;
    showApp();
    renderSidebar();
    renderReminderBanner();
    showToast('‚úÖ Connected to Google Sheets!');
  } catch(e) {
    errEl.textContent = '‚ùå Could not connect. ' + e.message;
    errEl.style.display = 'block';
  } finally { btn.disabled = false; btn.textContent = 'üîó Connect & Load Data'; }
}

function disconnectSheet() {
  if (!confirm('Disconnect?')) return;
  localStorage.removeItem('aquatrack_script_url');
  SCRIPT_URL = ''; appData = { customers: [], nextId: 1 }; selectedCustomerId = null;
  document.getElementById('setupScreen').style.display = 'flex';
  document.getElementById('appShell').style.display = 'none';
}

async function refreshData() {
  setSyncStatus('loading', '‚è≥ Syncing...');
  try {
    appData = await apiCall('getAll');
    renderSidebar();
    renderReminderBanner();
    if (selectedCustomerId) renderMain();
    setSyncStatus('ok', '‚úÖ Synced');
  } catch(e) { setSyncStatus('err', '‚ùå Sync failed'); }
}

// ============================================================
// API
// ============================================================
async function apiCall(action, body = {}, urlOverride = null) {
  const url = urlOverride || SCRIPT_URL;
  const isGet = action === 'getAll';
  const response = isGet
    ? await fetch(`${url}?action=getAll`)
    : await fetch(url, { method:'POST', body:JSON.stringify({ action, ...body }), headers:{ 'Content-Type':'text/plain' } });
  if (!response.ok) throw new Error('HTTP ' + response.status);
  const data = await response.json();
  if (data.error) throw new Error(data.error);
  return data;
}

// ============================================================
// UTILS
// ============================================================
function fmt(n) { return '‚Çπ' + Number(n).toLocaleString('en-IN', { minimumFractionDigits:0, maximumFractionDigits:2 }); }
function fmtDate(d) { if (!d) return '‚Äî'; return new Date(d).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }); }
function daysBetween(a, b) { return Math.round((new Date(b) - new Date(a)) / 86400000); }
function todayStr() { return new Date().toISOString().split('T')[0]; }
function addYears(d, y) { const dt = new Date(d); dt.setFullYear(dt.getFullYear()+y); return dt.toISOString().split('T')[0]; }
function addMonths(d, m) { const dt = new Date(d); dt.setMonth(dt.getMonth()+m); return dt.toISOString().split('T')[0]; }
function uid() { return 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); }

function amcStatus(c) {
  const today = todayStr();
  if (!c.amcEnd) return 'active';
  if (today > c.amcEnd) return 'expired';
  if (daysBetween(today, c.amcEnd) <= 30) return 'expiring';
  return 'active';
}
function totalComponentCost(c) {
  return (c.services||[]).reduce((s,sv) => s + (sv.components||[]).reduce((s2,co) => s2+(Number(co.price)||0),0), 0);
}
function setSyncStatus(type, text) {
  const el = document.getElementById('syncStatus');
  el.className = 'sync-status sync-' + type;
  el.textContent = text;
}
function showToast(msg) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// Schedule status for a single schedule item
function schedStatus(s) {
  if (s.status === 'done') return 'done';
  if (!s.dueDate) return 'pending';
  const days = daysBetween(todayStr(), s.dueDate);
  if (days < 0) return 'overdue';
  if (days <= 7) return 'due-soon';
  return 'pending';
}

// ============================================================
// REMINDER BANNER
// ============================================================
function renderReminderBanner() {
  const banner = document.getElementById('reminderBanner');
  const chips = document.getElementById('reminderChips');
  const reminders = [];

  (appData.customers || []).forEach(c => {
    (c.serviceSchedule || []).forEach(s => {
      if (s.status === 'done' || !s.dueDate) return;
      const days = daysBetween(todayStr(), s.dueDate);
      if (days >= 0 && days <= 7) reminders.push({ c, s, days });
    });
  });

  if (reminders.length === 0) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';

  chips.innerHTML = reminders.map(({c, s, days}) => {
    const label = days === 0 ? 'TODAY' : `in ${days}d`;
    return `<span class="reminder-chip" onclick="selectCustomer(${c.id})">
      <span>${c.name}</span>
      <span>¬∑</span>
      <span>${s.label}</span>
      <span class="days">‚è∞ ${label}</span>
    </span>`;
  }).join('');
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar() {
  const q = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const list = document.getElementById('customerList');

  let filtered = (appData.customers||[]).filter(c =>
    c.name.toLowerCase().includes(q)||(c.phone||'').includes(q)||(c.address||'').toLowerCase().includes(q)
  );

  // Apply type filter
  if (activeFilter === 'amc') filtered = filtered.filter(c => c.customerType !== 'regular');
  if (activeFilter === 'regular') filtered = filtered.filter(c => c.customerType === 'regular');

  if (!filtered.length) { list.innerHTML = `<div class="no-data">${appData.customers.length===0?'No customers yet.':'No results.'}</div>`; return; }

  list.innerHTML = filtered.map(c => {
    const isRegular = c.customerType === 'regular';

    if (isRegular) {
      // Regular customer ‚Äî show last visit date
      const visits = (c.services||[]);
      const lastVisit = visits.length ? [...visits].sort((a,b)=>new Date(b.date)-new Date(a.date))[0].date : null;
      return `<div class="customer-item ${selectedCustomerId===c.id?'active':''}" onclick="selectCustomer(${c.id})">
        <div class="c-name">${c.name}</div>
        <div class="c-meta">${c.phone?'üìû '+c.phone:''}</div>
        <div class="c-badges">
          <span class="c-badge badge-regular">üü¢ Regular</span>
          ${lastVisit?`<span class="c-badge badge-last-visit">Last: ${fmtDate(lastVisit)}</span>`:''}
        </div>
      </div>`;
    }

    // AMC customer
    const st = amcStatus(c);
    const badgeClass = st==='active'?'badge-active':st==='expired'?'badge-expired':'badge-expiring';
    const daysLeft = c.amcEnd ? Math.max(0, daysBetween(todayStr(), c.amcEnd)) : null;
    const badgeText = st==='expiring'?`Expiring in ${daysLeft}d`:st.charAt(0).toUpperCase()+st.slice(1);
    const hasDueSoon = (c.serviceSchedule||[]).some(s => {
      if (s.status==='done'||!s.dueDate) return false;
      return daysBetween(todayStr(), s.dueDate) <= 7;
    });

    return `<div class="customer-item ${selectedCustomerId===c.id?'active':''}" onclick="selectCustomer(${c.id})">
      <div class="c-name">${c.name}</div>
      <div class="c-meta">${c.phone?'üìû '+c.phone:''}</div>
      <div class="c-badges">
        <span class="c-badge badge-amc" style="background:rgba(0,212,255,.1);color:var(--accent);">üîµ AMC</span>
        <span class="c-badge ${badgeClass}">${badgeText}</span>
        ${hasDueSoon?'<span class="c-badge badge-reminder">‚ö†Ô∏è Service Due</span>':''}
      </div>
    </div>`;
  }).join('');
}

document.addEventListener('input', e => { if (e.target.id==='searchInput') renderSidebar(); });

// ============================================================
// MAIN PANEL
// ============================================================
function selectCustomer(id) {
  selectedCustomerId = id;
  renderSidebar();
  renderMain();
  // scroll main into view on mobile
  document.getElementById('mainContent').scrollTo(0,0);
}

function renderMain() {
  const c = appData.customers.find(x => x.id===selectedCustomerId);
  const main = document.getElementById('mainContent');
  if (!c) { main.innerHTML = `<div class="empty-state"><div style="font-size:48px;opacity:0.3;">üíß</div><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div></div>`; return; }

  // Route to different view for regular customers
  if (c.customerType === 'regular') { renderRegularMain(c); return; }

  const totalCost = totalComponentCost(c);
  const amcAmt = Number(c.amcAmount)||0;
  const profit = amcAmt - totalCost;
  const st = amcStatus(c);

  let progressPct=0, daysLeft=0, totalDays=365;
  if (c.amcStart && c.amcEnd) {
    totalDays = daysBetween(c.amcStart, c.amcEnd);
    progressPct = Math.min(100, Math.max(0, Math.round((daysBetween(c.amcStart,todayStr())/totalDays)*100)));
    daysLeft = Math.max(0, daysBetween(todayStr(), c.amcEnd));
  }
  const progressColor = st==='expired'?'var(--loss)':st==='expiring'?'var(--warn)':'var(--accent)';

  // Service schedule HTML


  // Service history HTML
  const servicesHtml = !(c.services||[]).length
    ? `<div class="no-data">No service visits logged yet.</div>`
    : `<table class="service-table">
        <thead><tr><th>Date</th><th>Type</th><th>Components Replaced</th><th>Total Cost</th><th>Notes</th><th></th></tr></thead>
        <tbody>
        ${[...(c.services||[])].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(s => {
          const sCost = (s.components||[]).reduce((sum,co)=>sum+(Number(co.price)||0),0);
          const typeClass = s.type==='free'?'type-free':s.type==='complaint'?'type-complaint':'type-paid';
          const typeLabel = s.type==='free'?'Free Service':s.type==='complaint'?'Complaint':'Paid';
          return `<tr>
            <td style="white-space:nowrap;">${fmtDate(s.date)}</td>
            <td><span class="service-type ${typeClass}">${typeLabel}</span></td>
            <td><div class="comp-chips">
              ${(s.components||[]).map(co=>`<span class="comp-chip">${co.name} <span class="price">${fmt(co.price)}</span></span>`).join('')}
              ${!(s.components||[]).length?'<span style="color:var(--text-dim);font-size:12px;">None</span>':''}
            </div></td>
            <td class="amount-cell">${sCost>0?fmt(sCost):'‚Äî'}</td>
            <td style="color:var(--text-dim);font-size:12px;">${s.notes||'‚Äî'}</td>
            <td><span class="delete-icon" onclick="deleteService(${c.id},'${s.id}')">üóëÔ∏è</span></td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>`;

  main.innerHTML = `
    <div class="customer-header">
      <div class="customer-title">
        <h2>üìã ${c.name}</h2>
        <p>${c.phone?'üìû '+c.phone:''} ${c.address?'  üìç '+c.address:''}</p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-accent" onclick="openAddService(${c.id})">+ Log Service Visit</button>
        <button class="btn btn-ghost" onclick="openEditCustomer(${c.id})">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">AMC Amount</div><div class="stat-value neutral">${fmt(amcAmt)}</div><div class="stat-sub">${totalDays} day contract</div></div>
      <div class="stat-card"><div class="stat-label">Components Cost</div><div class="stat-value" style="color:var(--text);">${fmt(totalCost)}</div><div class="stat-sub">${(c.services||[]).length} visit(s)</div></div>
      <div class="stat-card"><div class="stat-label">${profit>=0?'‚úÖ Profit':'‚ùå Loss'}</div><div class="stat-value ${profit>=0?'profit':'loss'}">${fmt(Math.abs(profit))}</div><div class="stat-sub">${profit>=0?'You\'re in profit':'You\'re in loss'}</div></div>
      <div class="stat-card">
        <div class="stat-label">AMC Status</div>
        <div class="stat-value" style="color:${progressColor};font-size:16px;">${st==='expired'?'Expired':daysLeft+' days left'+(st==='expiring'?' ‚ö†Ô∏è':'')}</div>
        <div class="progress-bar-wrap"><div class="progress-bar" style="width:${progressPct}%;background:${progressColor};"></div></div>
        <div class="stat-sub">${progressPct}% elapsed</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><span class="section-title">AMC Details</span></div>
      <div class="amc-info-grid">
        <div><div class="amc-info-label">Start Date</div><div class="amc-info-value">${fmtDate(c.amcStart)}</div></div>
        <div><div class="amc-info-label">End Date</div><div class="amc-info-value">${fmtDate(c.amcEnd)}</div></div>
        <div><div class="amc-info-label">RO Model</div><div class="amc-info-value">${c.roModel||'‚Äî'}</div></div>
        <div><div class="amc-info-label">Notes</div><div class="amc-info-value" style="font-family:'DM Sans';font-size:12px;">${c.notes||'‚Äî'}</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">üîß Service Visit Ledger</span>
        <button class="btn btn-accent btn-sm" onclick="openAddService(${c.id})">+ Log Visit</button>
      </div>
      ${servicesHtml}
    </div>`;
}

// ============================================================
// MARK SCHEDULE DONE
// ============================================================
async function markDone(customerId, scheduleId) {
  const doneDate = prompt('Enter done date (YYYY-MM-DD):', todayStr());
  if (!doneDate) return;
  try {
    setSyncStatus('loading', '‚è≥ Saving...');
    const result = await apiCall('markScheduleDone', { customerId, scheduleId, doneDate });
    // Update local state
    const c = appData.customers.find(x => x.id === customerId);
    c.serviceSchedule = result.customer.serviceSchedule;
    setSyncStatus('ok', '‚úÖ Synced');
    showToast('‚úÖ Service marked done. Next service due date auto-calculated!');
    renderMain();
    renderSidebar();
    renderReminderBanner();
  } catch(e) {
    setSyncStatus('err', '‚ùå Error');
    showToast('Error: ' + e.message);
  }
}

// ============================================================
// SCHEDULE EDITOR MODAL
// ============================================================
function openScheduleEditor(customerId) {
  const c = appData.customers.find(x => x.id === customerId);
  const schedule = c.serviceSchedule || [];

  openModal(`
    <h3>üìÖ Service Schedule ‚Äî ${c.name}</h3>
    <p style="color:var(--text-mid);font-size:13px;margin-bottom:16px;">Define when each free service should happen. The app will remind you 7 days before each one.</p>
    <div class="sched-rows" id="schedRows">
      ${schedule.map((s, idx) => schedRowHtml(s, idx)).join('')}
    </div>
    <button class="add-sched-btn" onclick="addSchedRow()">+ Add Service Slot</button>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveSchedBtn" onclick="saveSchedule(${customerId})">üíæ Save Schedule</button>
    </div>`);
}

function schedRowHtml(s, idx) {
  const isAfterPrev = s ? s.afterPrevious : false;
  const isFixedDate = s ? !!s.fixedDate : false;
  const rowId = (s && s.id) ? s.id : uid();
  const label = (s && s.label) ? s.label : '';
  const monthsFromStart = (s && s.monthsFromStart) ? s.monthsFromStart : 3;
  const monthsAfterPrev = (s && s.monthsAfterPrevious) ? s.monthsAfterPrevious : 4;
  const fixedDateVal = (s && s.fixedDate) ? s.fixedDate : todayStr();
  const isDone = s && s.status === 'done';

  let timingMode = 'fromStart';
  if (isAfterPrev) timingMode = 'afterPrev';
  if (isFixedDate) timingMode = 'fixedDate';

  const timingValHtml = timingMode === 'fixedDate'
    ? `<input type="date" value="${fixedDateVal}" style="background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px;outline:none;">`
    : timingMode === 'afterPrev'
    ? `<input type="number" min="0" max="24" value="${monthsAfterPrev}" style="width:60px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 8px;font-size:12px;outline:none;"> <label style="font-size:12px;color:var(--text-mid);">months after prev done</label>`
    : `<input type="number" min="0" max="24" value="${monthsFromStart}" style="width:60px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 8px;font-size:12px;outline:none;"> <label style="font-size:12px;color:var(--text-mid);">months from AMC start</label>`;

  return `<div class="sched-editor-row" data-sched-id="${rowId}">
    <div class="sched-row-top">
      <div class="sched-row-num">${idx+1}</div>
      <input class="form-input sched-label-input" placeholder="Label e.g. First Free Service" value="${label}">
      <button class="remove-sched-btn" onclick="this.closest('.sched-editor-row').remove(); renumberSchedRows();">√ó</button>
    </div>
    <div class="sched-timing">
      <label style="font-size:12px;color:var(--text-mid);">Timing:</label>
      <select onchange="toggleTimingMode(this)" style="background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px;outline:none;">
        <option value="fromStart" ${timingMode==='fromStart' ? 'selected' : ''}>Months from AMC Start</option>
        <option value="afterPrev" ${timingMode==='afterPrev' ? 'selected' : ''}>Months after Previous Done</option>
        <option value="fixedDate" ${timingMode==='fixedDate' ? 'selected' : ''}>üìÖ Pick Exact Date</option>
      </select>
      <div class="timing-val" style="display:flex;align-items:center;gap:8px;">${timingValHtml}</div>
    </div>
    ${isDone ? `<div style="font-size:12px;color:var(--profit);margin-top:6px;">‚úÖ Completed on ${fmtDate(s.doneDate)}</div>` : ''}
  </div>`;
}

function toggleTimingMode(sel) {
  const row = sel.closest('.sched-editor-row');
  const valDiv = row.querySelector('.timing-val');
  if (sel.value === 'fromStart') {
    valDiv.innerHTML = `<input type="number" min="0" max="24" value="3" style="width:60px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 8px;font-size:12px;outline:none;"> <label style="font-size:12px;color:var(--text-mid);">months from AMC start</label>`;
  } else if (sel.value === 'afterPrev') {
    valDiv.innerHTML = `<input type="number" min="0" max="24" value="4" style="width:60px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 8px;font-size:12px;outline:none;"> <label style="font-size:12px;color:var(--text-mid);">months after prev done</label>`;
  } else {
    valDiv.innerHTML = `<input type="date" value="${todayStr()}" style="background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px;outline:none;">`;
  }
}

function addSchedRow() {
  const rows = document.getElementById('schedRows');
  const idx = rows.children.length;
  const wrapper = document.createElement('div');
  wrapper.innerHTML = schedRowHtml(null, idx);
  rows.appendChild(wrapper.firstElementChild);
  renumberSchedRows();
}

function renumberSchedRows() {
  document.querySelectorAll('.sched-editor-row').forEach((row, idx) => {
    row.querySelector('.sched-row-num').textContent = idx + 1;
  });
}

async function saveSchedule(customerId) {
  const c = appData.customers.find(x => x.id === customerId);
  const existingSchedule = c.serviceSchedule || [];
  const rows = document.querySelectorAll('.sched-editor-row');
  const newSchedule = [];

  rows.forEach((row, idx) => {
    const id = row.dataset.schedId;
    const label = row.querySelector('.sched-label-input').value.trim() || `Service ${idx+1}`;
    const timingSelect = row.querySelector('select');
    const timingMode = timingSelect.value; // 'fromStart', 'afterPrev', 'fixedDate'
    const numInput = row.querySelector('input[type=number]');
    const dateInput = row.querySelector('input[type=date]');
    const val = parseInt(numInput?.value || 3);
    const afterPrevious = timingMode === 'afterPrev';
    const isFixedDate = timingMode === 'fixedDate';

    // Preserve existing status/doneDate if same id
    const existing = existingSchedule.find(s => s.id === id);
    let dueDate = existing?.dueDate || null;

    // Calculate due date based on timing mode
    if (!existing?.status || existing.status === 'pending') {
      if (isFixedDate && dateInput) {
        dueDate = dateInput.value; // use exactly what the user picked
      } else if (!afterPrevious && c.amcStart) {
        dueDate = addMonths(c.amcStart, val);
      }
      // afterPrevious due dates are calculated at markDone time
    }

    newSchedule.push({
      id,
      label,
      afterPrevious,
      fixedDate: isFixedDate ? (dateInput?.value || null) : null,
      monthsFromStart: timingMode === 'fromStart' ? val : null,
      monthsAfterPrevious: afterPrevious ? val : null,
      dueDate,
      status: existing?.status || 'pending',
      doneDate: existing?.doneDate || null
    });
  });

  const btn = document.getElementById('saveSchedBtn');
  btn.disabled = true; btn.textContent = 'Saving...';

  c.serviceSchedule = newSchedule;
  try {
    setSyncStatus('loading', '‚è≥ Saving...');
    await apiCall('saveCustomer', { customer: c });
    setSyncStatus('ok', '‚úÖ Synced');
    showToast('‚úÖ Schedule saved!');
    closeModal();
    renderMain();
    renderSidebar();
    renderReminderBanner();
  } catch(e) {
    setSyncStatus('err', '‚ùå Error');
    showToast('Error: ' + e.message);
    btn.disabled = false; btn.textContent = 'üíæ Save Schedule';
  }
}

// ============================================================
// REGULAR CUSTOMER VIEW
// ============================================================
function renderRegularMain(c) {
  const main = document.getElementById('mainContent');
  const visits = (c.services || []);
  const totalSpent = visits.reduce((sum, v) =>
    sum + (v.components||[]).reduce((s2, co) => s2 + (Number(co.price)||0), 0), 0);
  const lastVisit = visits.length ? [...visits].sort((a,b)=>new Date(b.date)-new Date(a.date))[0] : null;

  const historyHtml = !visits.length
    ? `<div class="no-data">No purchase history yet. Click "Log Purchase" to add one.</div>`
    : `<table class="service-table">
        <thead><tr><th>Date</th><th>Items Purchased</th><th>Total Amount</th><th>Notes</th><th></th></tr></thead>
        <tbody>
        ${[...visits].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(v => {
          const vCost = (v.components||[]).reduce((sum,co)=>sum+(Number(co.price)||0),0);
          return `<tr>
            <td style="white-space:nowrap;">${fmtDate(v.date)}</td>
            <td><div class="comp-chips">
              ${(v.components||[]).map(co=>`<span class="comp-chip">${co.name} <span class="price">${fmt(co.price)}</span></span>`).join('')}
              ${!(v.components||[]).length?'<span style="color:var(--text-dim);font-size:12px;">‚Äî</span>':''}
            </div></td>
            <td class="amount-cell">${vCost>0?fmt(vCost):'‚Äî'}</td>
            <td style="color:var(--text-dim);font-size:12px;">${v.notes||'‚Äî'}</td>
            <td><span class="delete-icon" onclick="deleteService(${c.id},'${v.id}')">üóëÔ∏è</span></td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>`;

  main.innerHTML = `
    <div class="customer-header">
      <div class="customer-title">
        <h2>üü¢ ${c.name}</h2>
        <p>${c.phone?'üìû '+c.phone:''} ${c.address?'  üìç '+c.address:''}</p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-accent" onclick="openAddRegularVisit(${c.id})">+ Log Purchase</button>
        <button class="btn btn-ghost" onclick="openEditCustomer(${c.id})">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
      </div>
    </div>

    <div class="stats-row" style="grid-template-columns:repeat(3,1fr);">
      <div class="stat-card">
        <div class="stat-label">Total Purchases</div>
        <div class="stat-value neutral">${visits.length}</div>
        <div class="stat-sub">Visit(s) on record</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Amount Spent</div>
        <div class="stat-value" style="color:var(--text);">${fmt(totalSpent)}</div>
        <div class="stat-sub">Across all visits</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Last Visit</div>
        <div class="stat-value" style="font-size:16px;color:var(--profit);">${lastVisit ? fmtDate(lastVisit.date) : '‚Äî'}</div>
        <div class="stat-sub">${lastVisit ? daysBetween(lastVisit.date, todayStr()) + ' days ago' : 'No visits yet'}</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">‚ÑπÔ∏è Customer Info</span>
      </div>
      <div class="amc-info-grid" style="grid-template-columns:repeat(3,1fr);">
        <div><div class="amc-info-label">RO Model</div><div class="amc-info-value">${c.roModel||'‚Äî'}</div></div>
        <div><div class="amc-info-label">Type</div><div class="amc-info-value" style="font-family:'DM Sans';color:var(--profit);">üü¢ Regular (No AMC)</div></div>
        <div><div class="amc-info-label">Notes</div><div class="amc-info-value" style="font-family:'DM Sans';font-size:12px;">${c.notes||'‚Äî'}</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">üõí Purchase History</span>
        <button class="btn btn-accent btn-sm" onclick="openAddRegularVisit(${c.id})">+ Log Purchase</button>
      </div>
      ${historyHtml}
    </div>`;
}

function openAddRegularVisit(customerId) {
  openModal(`
    <h3>üõí Log Purchase</h3>
    <div class="form-group"><label>Visit Date *</label><input class="form-input" id="s_date" type="date" value="${todayStr()}"></div>
    <div class="form-group">
      <label>Items / Components Purchased</label>
      <div class="comp-rows" id="compRows">
        <div class="comp-row">
          <input class="form-input" placeholder="Item name (e.g. Sediment Filter)" data-comp-name>
          <input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price>
          <button class="remove-comp-btn" onclick="this.closest('.comp-row').remove()">√ó</button>
        </div>
      </div>
      <button style="color:var(--accent);font-size:12px;cursor:pointer;background:none;border:none;text-decoration:underline;font-family:'DM Sans',sans-serif;" onclick="addCompRow()">+ Add item</button>
    </div>
    <div class="form-group"><label>Notes</label><input class="form-input" id="s_notes" placeholder="e.g. Customer complained about taste"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveServiceBtn" onclick="saveRegularVisit(${customerId})">Save Purchase</button>
    </div>`);
}

async function saveRegularVisit(customerId) {
  const date = document.getElementById('s_date').value;
  if (!date) { alert('Date required'); return; }
  const btn = document.getElementById('saveServiceBtn');
  btn.disabled=true; btn.textContent='Saving...';
  const notes = document.getElementById('s_notes').value.trim();
  const components = [];
  document.querySelectorAll('[data-comp-name]').forEach((inp,i) => {
    const name = inp.value.trim();
    if (name) components.push({ name, price: Number(document.querySelectorAll('[data-comp-price]')[i]?.value||0) });
  });
  const service = { id:uid(), date, type:'purchase', notes, components };
  try {
    setSyncStatus('loading','‚è≥ Saving...');
    await apiCall('saveService',{ customerId, service });
    const customer = appData.customers.find(c=>c.id===customerId);
    if (!customer.services) customer.services=[];
    customer.services.push(service);
    setSyncStatus('ok','‚úÖ Synced');
    showToast('‚úÖ Purchase logged in Google Sheets');
    closeModal(); renderMain();
  } catch(e) {
    setSyncStatus('err','‚ùå Error');
    showToast('Error: '+e.message);
    btn.disabled=false; btn.textContent='Save Purchase';
  }
}

// ============================================================
// MODALS ‚Äî CUSTOMER
// ============================================================
function openModal(html) { document.getElementById('modalBox').innerHTML = html; document.getElementById('modalOverlay').style.display = 'flex'; }
function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
function handleOverlayClick(e) { if (e.target===document.getElementById('modalOverlay')) closeModal(); }

function customerForm(c) {
  const isEdit = !!c;
  const isRegular = c?.customerType === 'regular';
  return `
    <h3>${isEdit?'‚úèÔ∏è Edit Customer':'üë§ New Customer'}</h3>

    <div class="form-group">
      <label>Customer Type</label>
      <div style="display:flex;gap:8px;">
        <button type="button" id="typeAMC" onclick="toggleCustomerType('amc')"
          class="btn ${!isRegular?'btn-accent':'btn-ghost'}" style="flex:1;">üîµ AMC Customer</button>
        <button type="button" id="typeRegular" onclick="toggleCustomerType('regular')"
          class="btn ${isRegular?'btn-green':'btn-ghost'}" style="flex:1;">üü¢ Regular Customer</button>
      </div>
      <input type="hidden" id="f_customerType" value="${isRegular?'regular':'amc'}">
    </div>

    <div class="form-row">
      <div class="form-group"><label>Customer Name *</label><input class="form-input" id="f_name" value="${c?.name||''}" placeholder="e.g. Ramesh Kumar"></div>
      <div class="form-group"><label>Phone</label><input class="form-input" id="f_phone" value="${c?.phone||''}" placeholder="9876543210"></div>
    </div>
    <div class="form-group"><label>Address</label><input class="form-input" id="f_address" value="${c?.address||''}" placeholder="House / Area"></div>
    <div class="form-group"><label>RO Model</label><input class="form-input" id="f_roModel" value="${c?.roModel||''}" placeholder="e.g. Kent Grand Plus"></div>

    <div id="amcFields" style="display:${isRegular?'none':'block'};">
      <div class="form-group"><label>AMC Amount (‚Çπ)</label><input class="form-input" id="f_amcAmount" type="number" value="${c?.amcAmount||''}" placeholder="5000"></div>
      <div class="form-row">
        <div class="form-group"><label>AMC Start Date</label><input class="form-input" id="f_amcStart" type="date" value="${c?.amcStart||todayStr()}"></div>
        <div class="form-group"><label>AMC End Date</label><input class="form-input" id="f_amcEnd" type="date" value="${c?.amcEnd||addYears(todayStr(),1)}"></div>
      </div>
    </div>

    <div class="form-group"><label>Notes</label><input class="form-input" id="f_notes" value="${c?.notes||''}" placeholder="Any special notes..."></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveCustomerBtn" onclick="saveCustomer(${c?.id||'null'})">${isEdit?'Save Changes':'Add Customer'}</button>
    </div>`;
}

function toggleCustomerType(type) {
  document.getElementById('f_customerType').value = type;
  const amcBtn = document.getElementById('typeAMC');
  const regBtn = document.getElementById('typeRegular');
  const amcFields = document.getElementById('amcFields');
  if (type === 'amc') {
    amcBtn.className = 'btn btn-accent'; amcBtn.style.flex = '1';
    regBtn.className = 'btn btn-ghost'; regBtn.style.flex = '1';
    amcFields.style.display = 'block';
  } else {
    amcBtn.className = 'btn btn-ghost'; amcBtn.style.flex = '1';
    regBtn.className = 'btn btn-green'; regBtn.style.flex = '1';
    amcFields.style.display = 'none';
  }
}

function openAddCustomer() { openModal(customerForm(null)); }
function openEditCustomer(id) { openModal(customerForm(appData.customers.find(x=>x.id===id))); }

async function saveCustomer(id) {
  const name = document.getElementById('f_name').value.trim();
  if (!name) { alert('Name required'); return; }
  const btn = document.getElementById('saveCustomerBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  const isNew = !id;
  const customerId = isNew ? appData.nextId : id;
  const existing = isNew ? null : appData.customers.find(c=>c.id===id);
  const customerType = document.getElementById('f_customerType').value;
  const isRegular = customerType === 'regular';
  const customer = {
    id: customerId,
    customerType,
    name,
    phone: document.getElementById('f_phone').value.trim(),
    address: document.getElementById('f_address').value.trim(),
    roModel: document.getElementById('f_roModel').value.trim(),
    amcAmount: isRegular ? null : document.getElementById('f_amcAmount').value,
    amcStart: isRegular ? null : document.getElementById('f_amcStart').value,
    amcEnd: isRegular ? null : document.getElementById('f_amcEnd').value,
    notes: document.getElementById('f_notes').value.trim(),
    services: existing?.services || [],
    serviceSchedule: isRegular ? [] : (existing?.serviceSchedule || [])
  };
  try {
    setSyncStatus('loading', '‚è≥ Saving...');
    await apiCall('saveCustomer', { customer });
    if (isNew) { appData.customers.push(customer); appData.nextId++; selectedCustomerId = customerId; }
    else { const idx = appData.customers.findIndex(c=>c.id===id); appData.customers[idx] = customer; }
    setSyncStatus('ok', '‚úÖ Synced');
    showToast(isNew?'‚úÖ Customer added':'‚úÖ Customer updated');
    closeModal(); renderSidebar(); renderMain();
  } catch(e) {
    setSyncStatus('err', '‚ùå Error');
    showToast('Error: '+e.message);
    btn.disabled=false; btn.textContent=isNew?'Add Customer':'Save Changes';
  }
}

async function deleteCustomer(id) {
  if (!confirm('Delete this customer?')) return;
  try {
    setSyncStatus('loading','‚è≥ Deleting...');
    await apiCall('deleteCustomer',{customerId:id});
    appData.customers = appData.customers.filter(c=>c.id!==id);
    selectedCustomerId = null;
    setSyncStatus('ok','‚úÖ Synced');
    showToast('Customer deleted');
    renderSidebar(); renderMain(); renderReminderBanner();
  } catch(e) { showToast('Error: '+e.message); }
}

// ============================================================
// MODALS ‚Äî SERVICE VISIT
// ============================================================
function openAddService(customerId) {
  openModal(`
    <h3>üîß Log Service Visit</h3>
    <div class="form-row">
      <div class="form-group"><label>Visit Date *</label><input class="form-input" id="s_date" type="date" value="${todayStr()}"></div>
      <div class="form-group"><label>Visit Type</label>
        <select class="form-select" id="s_type">
          <option value="free">Free Service</option>
          <option value="complaint">Complaint Visit</option>
          <option value="paid">Paid (Extra)</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Components Replaced</label>
      <div class="comp-rows" id="compRows">
        <div class="comp-row">
          <input class="form-input" placeholder="Component name" data-comp-name>
          <input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price>
          <button class="remove-comp-btn" onclick="this.closest('.comp-row').remove()">√ó</button>
        </div>
      </div>
      <button style="color:var(--accent);font-size:12px;cursor:pointer;background:none;border:none;text-decoration:underline;font-family:'DM Sans',sans-serif;" onclick="addCompRow()">+ Add component</button>
    </div>
    <div class="form-group"><label>Notes</label><input class="form-input" id="s_notes" placeholder="e.g. Low pressure complaint"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveServiceBtn" onclick="saveService(${customerId})">Save Visit</button>
    </div>`);
}

function addCompRow() {
  const row = document.createElement('div');
  row.className = 'comp-row';
  row.innerHTML = `<input class="form-input" placeholder="Component name" data-comp-name><input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price><button class="remove-comp-btn" onclick="this.closest('.comp-row').remove()">√ó</button>`;
  document.getElementById('compRows').appendChild(row);
}

async function saveService(customerId) {
  const date = document.getElementById('s_date').value;
  if (!date) { alert('Date required'); return; }
  const btn = document.getElementById('saveServiceBtn');
  btn.disabled=true; btn.textContent='Saving...';
  const type = document.getElementById('s_type').value;
  const notes = document.getElementById('s_notes').value.trim();
  const components = [];
  document.querySelectorAll('[data-comp-name]').forEach((inp,i) => {
    const name = inp.value.trim();
    if (name) components.push({ name, price: Number(document.querySelectorAll('[data-comp-price]')[i]?.value||0) });
  });
  const service = { id:uid(), date, type, notes, components };
  try {
    setSyncStatus('loading','‚è≥ Saving...');
    await apiCall('saveService',{ customerId, service });
    const customer = appData.customers.find(c=>c.id===customerId);
    if (!customer.services) customer.services=[];
    customer.services.push(service);
    setSyncStatus('ok','‚úÖ Synced');
    showToast('‚úÖ Visit logged in Google Sheets');
    closeModal(); renderMain();
  } catch(e) {
    setSyncStatus('err','‚ùå Error');
    showToast('Error: '+e.message);
    btn.disabled=false; btn.textContent='Save Visit';
  }
}

async function deleteService(customerId, serviceId) {
  if (!confirm('Remove this visit?')) return;
  try {
    setSyncStatus('loading','‚è≥ Deleting...');
    await apiCall('deleteService',{customerId,serviceId});
    const c = appData.customers.find(x=>x.id===customerId);
    c.services = c.services.filter(s=>s.id!==serviceId);
    setSyncStatus('ok','‚úÖ Synced'); showToast('Visit deleted'); renderMain();
  } catch(e) { showToast('Error: '+e.message); }
}
</script>
</body>
</html>
