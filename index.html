<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaTrack ‚Äî RO Filter AMC Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1f2d47;
    --accent: #00d4ff;
    --accent2: #0099bb;
    --profit: #22d3a5;
    --loss: #f87171;
    --warn: #fbbf24;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-mid: #94a3b8;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

  /* SETUP SCREEN */
  .setup-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; padding: 20px;
  }
  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 540px;
  }
  .setup-card h1 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 28px; color: var(--accent); margin-bottom: 6px; }
  .setup-card p { color: var(--text-mid); font-size: 14px; margin-bottom: 28px; }
  .setup-steps { margin-bottom: 24px; }
  .setup-step {
    display: flex; gap: 14px; align-items: flex-start;
    padding: 12px 0; border-bottom: 1px solid var(--border);
  }
  .setup-step:last-child { border-bottom: none; }
  .step-num {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--accent); color: #000;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 1px;
  }
  .step-text { font-size: 13px; color: var(--text-mid); line-height: 1.6; }
  .step-text strong { color: var(--text); }
  .step-text a { color: var(--accent); }
  .url-input-wrap { margin-top: 20px; }
  .url-input-wrap label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-dim); margin-bottom: 8px; }
  .url-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 14px; color: var(--text);
    font-family: 'DM Mono', monospace; font-size: 12px; outline: none;
    transition: border-color 0.2s;
  }
  .url-input:focus { border-color: var(--accent); }
  .connect-btn {
    width: 100%; margin-top: 14px; background: var(--accent); color: #000;
    border: none; border-radius: 8px; padding: 12px;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px;
    cursor: pointer; transition: background 0.2s;
  }
  .connect-btn:hover { background: #00b8d9; }
  .connect-btn:disabled { opacity: 0.6; cursor: not-allowed; }

  /* MAIN APP */
  #appShell { display: none; }
  header {
    background: linear-gradient(135deg, #0a0f1e 0%, #0d1a2e 100%);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; color: var(--accent); }
  .logo span { color: var(--text); }
  .header-right { display: flex; gap: 10px; align-items: center; }
  .sync-status { font-size: 11px; padding: 4px 10px; border-radius: 20px; }
  .sync-ok { background: rgba(34,211,165,0.12); color: var(--profit); }
  .sync-err { background: rgba(248,113,113,0.12); color: var(--loss); }
  .sync-loading { background: rgba(0,212,255,0.1); color: var(--accent); }

  .app { display: flex; height: calc(100vh - 53px); }
  .sidebar { width: 300px; min-width: 260px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
  .main { flex: 1; overflow-y: auto; padding: 24px; }

  .sidebar-top { padding: 14px; border-bottom: 1px solid var(--border); }
  .search-box {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 9px 12px; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; transition: border-color 0.2s;
  }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--text-dim); }
  .add-customer-btn {
    width: 100%; margin-top: 10px; background: var(--accent); color: #000;
    border: none; border-radius: 8px; padding: 9px;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; transition: background 0.2s;
  }
  .add-customer-btn:hover { background: #00b8d9; }

  .customer-list { overflow-y: auto; flex: 1; }
  .customer-item { padding: 13px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  .customer-item:hover { background: var(--surface2); }
  .customer-item.active { background: rgba(0,212,255,0.07); border-left: 3px solid var(--accent); }
  .c-name { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 14px; }
  .c-meta { font-size: 12px; color: var(--text-dim); margin-top: 3px; }
  .c-badge { font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px; display: inline-block; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge-active { background: rgba(34,211,165,0.15); color: var(--profit); }
  .badge-expired { background: rgba(248,113,113,0.15); color: var(--loss); }
  .badge-expiring { background: rgba(251,191,36,0.15); color: var(--warn); }

  .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); gap: 12px; text-align: center; }

  .customer-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; gap: 16px; flex-wrap: wrap; }
  .customer-title h2 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 26px; }
  .customer-title p { color: var(--text-mid); margin-top: 4px; font-size: 13px; }

  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
  .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .stat-value { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 22px; }
  .stat-value.profit { color: var(--profit); }
  .stat-value.loss { color: var(--loss); }
  .stat-value.neutral { color: var(--accent); }
  .stat-sub { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

  .section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
  .section-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .section-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }

  .btn { border: none; border-radius: 7px; padding: 7px 14px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
  .btn-accent { background: var(--accent); color: #000; font-weight: 700; }
  .btn-accent:hover { background: #00b8d9; }
  .btn-accent:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-ghost { background: var(--surface2); color: var(--text-mid); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); }
  .btn-danger { background: rgba(248,113,113,0.1); color: var(--loss); border: 1px solid rgba(248,113,113,0.2); }
  .btn-danger:hover { background: rgba(248,113,113,0.2); }

  .service-table { width: 100%; border-collapse: collapse; }
  .service-table th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-dim); font-family: 'DM Mono', monospace; padding: 10px 18px; text-align: left; border-bottom: 1px solid var(--border); font-weight: 500; }
  .service-table td { padding: 12px 18px; border-bottom: 1px solid rgba(31,45,71,0.5); font-size: 13px; }
  .service-table tr:last-child td { border-bottom: none; }
  .service-table tr:hover td { background: rgba(255,255,255,0.02); }
  .service-type { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px; }
  .type-free { background: rgba(34,211,165,0.12); color: var(--profit); }
  .type-complaint { background: rgba(251,191,36,0.12); color: var(--warn); }
  .type-paid { background: rgba(248,113,113,0.12); color: var(--loss); }
  .amount-cell { font-family: 'DM Mono', monospace; font-weight: 500; }

  .comp-chips { display: flex; flex-wrap: wrap; gap: 6px; }
  .comp-chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 3px 9px; font-size: 12px; color: var(--text-mid); display: flex; align-items: center; gap: 5px; }
  .comp-chip .price { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent); }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; width: 100%; max-width: 520px; max-height: 88vh; overflow-y: auto; }
  .modal h3 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; margin-bottom: 20px; color: var(--accent); }
  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-dim); margin-bottom: 6px; font-weight: 500; }
  .form-input, .form-select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; transition: border-color 0.2s; }
  .form-input:focus, .form-select:focus { border-color: var(--accent); }
  .form-select option { background: var(--surface2); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  .comp-rows { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
  .comp-row { display: flex; gap: 8px; align-items: center; }
  .comp-row .form-input { flex: 1; }
  .comp-row .price-input { width: 110px; min-width: 110px; }
  .remove-comp-btn { background: none; border: none; color: var(--loss); cursor: pointer; font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px; }
  .remove-comp-btn:hover { background: rgba(248,113,113,0.1); }
  .add-comp-link { color: var(--accent); font-size: 12px; cursor: pointer; background: none; border: none; padding: 0; font-family: 'DM Sans', sans-serif; text-decoration: underline; }

  .no-data { padding: 28px; text-align: center; color: var(--text-dim); font-size: 13px; }
  .progress-bar-wrap { height: 6px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
  .progress-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .amc-info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 16px 18px; }
  .amc-info-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.6px; }
  .amc-info-value { font-family: 'DM Mono', monospace; font-size: 14px; margin-top: 4px; color: var(--text); }
  .delete-icon { cursor: pointer; opacity: 0.5; transition: opacity 0.15s; }
  .delete-icon:hover { opacity: 1; color: var(--loss); }

  /* Loading spinner */
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,212,255,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px; font-size: 13px; z-index: 999; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  @media (max-width: 900px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .amc-info-grid { grid-template-columns: repeat(2, 1fr); }
    .sidebar { width: 260px; }
  }
  @media (max-width: 650px) {
    .app { flex-direction: column; }
    .sidebar { width: 100%; height: auto; max-height: 240px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- ===== SETUP SCREEN ===== -->
<div class="setup-screen" id="setupScreen">
  <div class="setup-card">
    <h1>üíß AquaTrack</h1>
    <p>Connect your Google Sheet to get started. Data will sync across all devices in real time.</p>

    <div class="setup-steps">
      <div class="setup-step">
        <div class="step-num">1</div>
        <div class="step-text">
          Go to <a href="https://script.google.com" target="_blank">script.google.com</a> ‚Üí Create a <strong>New Project</strong>
        </div>
      </div>
      <div class="setup-step">
        <div class="step-num">2</div>
        <div class="step-text">
          Paste the <strong>Apps Script code</strong> provided separately and click Save
        </div>
      </div>
      <div class="setup-step">
        <div class="step-num">3</div>
        <div class="step-text">
          Click <strong>Deploy ‚Üí New Deployment</strong><br>
          Type: <strong>Web App</strong> ¬∑ Execute as: <strong>Me</strong> ¬∑ Access: <strong>Anyone</strong>
        </div>
      </div>
      <div class="setup-step">
        <div class="step-num">4</div>
        <div class="step-text">
          Copy the <strong>Web App URL</strong> and paste it below
        </div>
      </div>
    </div>

    <div class="url-input-wrap">
      <label>Google Apps Script Web App URL</label>
      <input class="url-input" id="scriptUrlInput" type="url"
        placeholder="https://script.google.com/macros/s/XXXXXXX/exec">
    </div>
    <button class="connect-btn" id="connectBtn" onclick="connectSheet()">üîó Connect & Load Data</button>
    <div id="connectError" style="color:var(--loss);font-size:12px;margin-top:10px;display:none;"></div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="appShell">
  <header>
    <div class="logo">Aqua<span>Track</span></div>
    <div class="header-right">
      <span class="sync-status sync-ok" id="syncStatus">‚úÖ Synced</span>
      <button class="btn btn-ghost" onclick="refreshData()" style="font-size:11px;">‚ü≥ Refresh</button>
      <button class="btn btn-ghost" onclick="disconnectSheet()" style="font-size:11px;">Disconnect</button>
    </div>
  </header>

  <div class="app">
    <div class="sidebar">
      <div class="sidebar-top">
        <input class="search-box" id="searchInput" type="text" placeholder="üîç  Search customer...">
        <button class="add-customer-btn" onclick="openAddCustomer()">+ Add New Customer</button>
      </div>
      <div class="customer-list" id="customerList">
        <div class="no-data"><span class="spinner"></span> Loading...</div>
      </div>
    </div>
    <div class="main" id="mainContent">
      <div class="empty-state">
        <div style="font-size:48px;opacity:0.3;">üíß</div>
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div>
        <div style="max-width:260px;color:var(--text-dim);font-size:13px;">Choose a customer from the sidebar to view their AMC ledger.</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" style="display:none;" onclick="handleOverlayClick(event)">
  <div class="modal" id="modalBox"></div>
</div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
let SCRIPT_URL = localStorage.getItem('aquatrack_script_url') || '';
let appData = { customers: [], nextId: 1 };
let selectedCustomerId = null;
let isSyncing = false;

// ============================================================
// INIT
// ============================================================
window.onload = () => {
  if (SCRIPT_URL) {
    showApp();
    refreshData();
  }
};

function showApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';
}

function showSetup() {
  document.getElementById('setupScreen').style.display = 'flex';
  document.getElementById('appShell').style.display = 'none';
}

async function connectSheet() {
  const url = document.getElementById('scriptUrlInput').value.trim();
  const errEl = document.getElementById('connectError');
  const btn = document.getElementById('connectBtn');
  errEl.style.display = 'none';

  if (!url.includes('script.google.com')) {
    errEl.textContent = '‚ö†Ô∏è Please paste a valid Google Apps Script URL.';
    errEl.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = '‚è≥ Connecting...';

  try {
    const result = await apiCall('getAll', {}, url);
    SCRIPT_URL = url;
    localStorage.setItem('aquatrack_script_url', url);
    appData = result;
    showApp();
    renderSidebar();
    showToast('‚úÖ Connected to Google Sheets!', 'profit');
  } catch(e) {
    errEl.textContent = '‚ùå Could not connect. Check the URL and make sure the deployment is set to "Anyone". Error: ' + e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîó Connect & Load Data';
  }
}

function disconnectSheet() {
  if (!confirm('Disconnect from Google Sheets? The app URL will need to be re-entered.')) return;
  localStorage.removeItem('aquatrack_script_url');
  SCRIPT_URL = '';
  appData = { customers: [], nextId: 1 };
  selectedCustomerId = null;
  showSetup();
}

async function refreshData() {
  setSyncStatus('loading', '‚è≥ Syncing...');
  try {
    const result = await apiCall('getAll');
    appData = result;
    renderSidebar();
    if (selectedCustomerId) renderMain();
    setSyncStatus('ok', '‚úÖ Synced');
    showToast('Data refreshed from Google Sheets', 'ok');
  } catch(e) {
    setSyncStatus('err', '‚ùå Sync failed');
    showToast('Could not sync: ' + e.message, 'err');
  }
}

// ============================================================
// API
// ============================================================
async function apiCall(action, body = {}, urlOverride = null) {
  const url = urlOverride || SCRIPT_URL;
  const payload = { action, ...body };

  // Use POST via a form-based no-cors fetch workaround:
  // Actually use standard fetch with JSONP-style GET for getAll, POST for mutations
  const isGet = action === 'getAll';

  let response;
  if (isGet) {
    response = await fetch(`${url}?action=getAll`, { method: 'GET' });
  } else {
    response = await fetch(url, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'text/plain' } // avoid CORS preflight
    });
  }

  if (!response.ok) throw new Error('HTTP ' + response.status);
  const data = await response.json();
  if (data.error) throw new Error(data.error);
  return data;
}

// ============================================================
// UTILS
// ============================================================
function fmt(n) { return '‚Çπ' + Number(n).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
function fmtDate(d) { if (!d) return '‚Äî'; return new Date(d).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }); }
function daysBetween(a, b) { return Math.round((new Date(b) - new Date(a)) / 86400000); }
function todayStr() { return new Date().toISOString().split('T')[0]; }
function addYears(dateStr, y) { const d = new Date(dateStr); d.setFullYear(d.getFullYear() + y); return d.toISOString().split('T')[0]; }
function uid() { return 'svc_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); }

function amcStatus(c) {
  const today = todayStr();
  if (!c.amcEnd) return 'active';
  if (today > c.amcEnd) return 'expired';
  if (daysBetween(today, c.amcEnd) <= 30) return 'expiring';
  return 'active';
}

function totalComponentCost(customer) {
  return (customer.services || []).reduce((sum, s) =>
    sum + (s.components || []).reduce((s2, c) => s2 + (Number(c.price) || 0), 0), 0);
}

function setSyncStatus(type, text) {
  const el = document.getElementById('syncStatus');
  el.className = 'sync-status sync-' + type;
  el.textContent = text;
}

function showToast(msg, type = 'ok') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.className = 'toast';
  t.style.color = type === 'profit' || type === 'ok' ? 'var(--profit)' : type === 'err' ? 'var(--loss)' : 'var(--accent)';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar() {
  const q = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const list = document.getElementById('customerList');
  const filtered = (appData.customers || []).filter(c =>
    c.name.toLowerCase().includes(q) || (c.phone || '').includes(q) || (c.address || '').toLowerCase().includes(q)
  );

  if (filtered.length === 0) {
    list.innerHTML = `<div class="no-data">${appData.customers.length === 0 ? 'No customers yet. Add your first one!' : 'No results.'}</div>`;
    return;
  }

  list.innerHTML = filtered.map(c => {
    const st = amcStatus(c);
    const badgeClass = st === 'active' ? 'badge-active' : st === 'expired' ? 'badge-expired' : 'badge-expiring';
    const daysLeft = c.amcEnd ? Math.max(0, daysBetween(todayStr(), c.amcEnd)) : null;
    const badgeText = st === 'expiring' ? `Expiring in ${daysLeft}d` : st.charAt(0).toUpperCase() + st.slice(1);
    return `<div class="customer-item ${selectedCustomerId === c.id ? 'active' : ''}" onclick="selectCustomer(${c.id})">
      <div class="c-name">${c.name}</div>
      <div class="c-meta">${c.phone ? 'üìû ' + c.phone : ''}</div>
      <div>
        <span class="c-badge ${badgeClass}">${badgeText}</span>
        ${c.amcEnd ? `<span class="c-badge" style="background:var(--surface2);color:var(--text-dim);">Till ${fmtDate(c.amcEnd)}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

document.addEventListener('input', e => { if (e.target.id === 'searchInput') renderSidebar(); });

// ============================================================
// MAIN PANEL
// ============================================================
function selectCustomer(id) {
  selectedCustomerId = id;
  renderSidebar();
  renderMain();
}

function renderMain() {
  const c = appData.customers.find(x => x.id === selectedCustomerId);
  const main = document.getElementById('mainContent');
  if (!c) { main.innerHTML = `<div class="empty-state"><div style="font-size:48px;opacity:0.3;">üíß</div><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div></div>`; return; }

  const totalCost = totalComponentCost(c);
  const amcAmt = Number(c.amcAmount) || 0;
  const profit = amcAmt - totalCost;
  const st = amcStatus(c);

  let progressPct = 0, daysLeft = 0, totalDays = 365;
  if (c.amcStart && c.amcEnd) {
    totalDays = daysBetween(c.amcStart, c.amcEnd);
    progressPct = Math.min(100, Math.max(0, Math.round((daysBetween(c.amcStart, todayStr()) / totalDays) * 100)));
    daysLeft = Math.max(0, daysBetween(todayStr(), c.amcEnd));
  }
  const progressColor = st === 'expired' ? 'var(--loss)' : st === 'expiring' ? 'var(--warn)' : 'var(--accent)';

  const servicesHtml = !(c.services || []).length
    ? `<div class="no-data">No service visits yet.</div>`
    : `<table class="service-table">
        <thead><tr><th>Date</th><th>Type</th><th>Components Replaced</th><th>Total Cost</th><th>Notes</th><th></th></tr></thead>
        <tbody>
        ${[...(c.services || [])].sort((a,b) => new Date(b.date)-new Date(a.date)).map(s => {
          const sCost = (s.components||[]).reduce((sum,comp) => sum + (Number(comp.price)||0), 0);
          const typeClass = s.type === 'free' ? 'type-free' : s.type === 'complaint' ? 'type-complaint' : 'type-paid';
          const typeLabel = s.type === 'free' ? 'Free Service' : s.type === 'complaint' ? 'Complaint' : 'Paid';
          return `<tr>
            <td style="white-space:nowrap;">${fmtDate(s.date)}</td>
            <td><span class="service-type ${typeClass}">${typeLabel}</span></td>
            <td><div class="comp-chips">
              ${(s.components||[]).map(comp => `<span class="comp-chip">${comp.name} <span class="price">${fmt(comp.price)}</span></span>`).join('')}
              ${!(s.components||[]).length ? '<span style="color:var(--text-dim);font-size:12px;">None</span>' : ''}
            </div></td>
            <td class="amount-cell">${sCost > 0 ? fmt(sCost) : '‚Äî'}</td>
            <td style="color:var(--text-dim);font-size:12px;">${s.notes || '‚Äî'}</td>
            <td><span class="delete-icon" onclick="deleteService(${c.id},'${s.id}')">üóëÔ∏è</span></td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>`;

  main.innerHTML = `
    <div class="customer-header">
      <div class="customer-title">
        <h2>üìã ${c.name}</h2>
        <p>${c.phone ? 'üìû ' + c.phone : ''} ${c.address ? '  üìç ' + c.address : ''}</p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-accent" onclick="openAddService(${c.id})">+ Add Service Visit</button>
        <button class="btn btn-ghost" onclick="openEditCustomer(${c.id})">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger" onclick="deleteCustomer(${c.id})">üóëÔ∏è Delete</button>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">AMC Amount</div><div class="stat-value neutral">${fmt(amcAmt)}</div><div class="stat-sub">${totalDays} day contract</div></div>
      <div class="stat-card"><div class="stat-label">Components Cost</div><div class="stat-value" style="color:var(--text);">${fmt(totalCost)}</div><div class="stat-sub">${(c.services||[]).length} visit(s)</div></div>
      <div class="stat-card"><div class="stat-label">${profit >= 0 ? '‚úÖ Profit' : '‚ùå Loss'}</div><div class="stat-value ${profit >= 0 ? 'profit' : 'loss'}">${fmt(Math.abs(profit))}</div><div class="stat-sub">${profit >= 0 ? 'You\'re in profit' : 'You\'re in loss'}</div></div>
      <div class="stat-card">
        <div class="stat-label">AMC Status</div>
        <div class="stat-value" style="color:${progressColor};font-size:16px;">${st === 'expired' ? 'Expired' : daysLeft + ' days left' + (st === 'expiring' ? ' ‚ö†Ô∏è' : '')}</div>
        <div class="progress-bar-wrap"><div class="progress-bar" style="width:${progressPct}%;background:${progressColor};"></div></div>
        <div class="stat-sub">${progressPct}% of AMC elapsed</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><span class="section-title">AMC Details</span></div>
      <div class="amc-info-grid">
        <div><div class="amc-info-label">Start Date</div><div class="amc-info-value">${fmtDate(c.amcStart)}</div></div>
        <div><div class="amc-info-label">End Date</div><div class="amc-info-value">${fmtDate(c.amcEnd)}</div></div>
        <div><div class="amc-info-label">RO Model</div><div class="amc-info-value">${c.roModel || '‚Äî'}</div></div>
        <div><div class="amc-info-label">Free Services Included</div><div class="amc-info-value">${c.freeServices || '‚Äî'}</div></div>
        <div><div class="amc-info-label">Free Services Used</div><div class="amc-info-value">${(c.services||[]).filter(s=>s.type==='free').length}</div></div>
        <div><div class="amc-info-label">Notes</div><div class="amc-info-value" style="font-family:'DM Sans';font-size:12px;">${c.notes || '‚Äî'}</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">üîß Service Visit Ledger</span>
        <button class="btn btn-accent" onclick="openAddService(${c.id})">+ Log Visit</button>
      </div>
      ${servicesHtml}
    </div>`;
}

// ============================================================
// MODALS
// ============================================================
function openModal(html) { document.getElementById('modalBox').innerHTML = html; document.getElementById('modalOverlay').style.display = 'flex'; }
function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
function handleOverlayClick(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

function customerForm(c) {
  const isEdit = !!c;
  return `
    <h3>${isEdit ? '‚úèÔ∏è Edit Customer' : 'üë§ New Customer'}</h3>
    <div class="form-row">
      <div class="form-group"><label>Customer Name *</label><input class="form-input" id="f_name" value="${c?.name||''}" placeholder="e.g. Ramesh Kumar"></div>
      <div class="form-group"><label>Phone</label><input class="form-input" id="f_phone" value="${c?.phone||''}" placeholder="9876543210"></div>
    </div>
    <div class="form-group"><label>Address</label><input class="form-input" id="f_address" value="${c?.address||''}" placeholder="House / Area"></div>
    <div class="form-row">
      <div class="form-group"><label>RO Model</label><input class="form-input" id="f_roModel" value="${c?.roModel||''}" placeholder="e.g. Kent Grand Plus"></div>
      <div class="form-group"><label>AMC Amount (‚Çπ)</label><input class="form-input" id="f_amcAmount" type="number" value="${c?.amcAmount||''}" placeholder="5000"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>AMC Start Date</label><input class="form-input" id="f_amcStart" type="date" value="${c?.amcStart||todayStr()}"></div>
      <div class="form-group"><label>AMC End Date</label><input class="form-input" id="f_amcEnd" type="date" value="${c?.amcEnd||addYears(todayStr(),1)}"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Free Services Included / Year</label><input class="form-input" id="f_freeServices" type="number" value="${c?.freeServices||2}" placeholder="2"></div>
    </div>
    <div class="form-group"><label>Notes</label><input class="form-input" id="f_notes" value="${c?.notes||''}" placeholder="Any special notes..."></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveCustomerBtn" onclick="saveCustomer(${c?.id||'null'})">${isEdit ? 'Save Changes' : 'Add Customer'}</button>
    </div>`;
}

function openAddCustomer() { openModal(customerForm(null)); }
function openEditCustomer(id) { openModal(customerForm(appData.customers.find(x => x.id === id))); }

async function saveCustomer(id) {
  const name = document.getElementById('f_name').value.trim();
  if (!name) { alert('Customer name is required'); return; }

  const btn = document.getElementById('saveCustomerBtn');
  btn.disabled = true; btn.textContent = 'Saving...';

  const isNew = !id;
  const customerId = isNew ? appData.nextId : id;

  const existing = isNew ? null : appData.customers.find(c => c.id === id);
  const customer = {
    id: customerId,
    name,
    phone: document.getElementById('f_phone').value.trim(),
    address: document.getElementById('f_address').value.trim(),
    roModel: document.getElementById('f_roModel').value.trim(),
    amcAmount: document.getElementById('f_amcAmount').value,
    amcStart: document.getElementById('f_amcStart').value,
    amcEnd: document.getElementById('f_amcEnd').value,
    freeServices: document.getElementById('f_freeServices').value,
    notes: document.getElementById('f_notes').value.trim(),
    services: existing?.services || []
  };

  try {
    setSyncStatus('loading', '‚è≥ Saving...');
    await apiCall('saveCustomer', { customer });

    if (isNew) {
      appData.customers.push(customer);
      appData.nextId++;
      selectedCustomerId = customerId;
    } else {
      const idx = appData.customers.findIndex(c => c.id === id);
      appData.customers[idx] = customer;
    }
    setSyncStatus('ok', '‚úÖ Synced');
    showToast(isNew ? '‚úÖ Customer added to Google Sheets' : '‚úÖ Customer updated', 'profit');
    closeModal();
    renderSidebar();
    renderMain();
  } catch(e) {
    setSyncStatus('err', '‚ùå Save failed');
    showToast('Save failed: ' + e.message, 'err');
    btn.disabled = false; btn.textContent = 'Save';
  }
}

async function deleteCustomer(id) {
  if (!confirm('Delete this customer and all their service records from Google Sheets?')) return;
  try {
    setSyncStatus('loading', '‚è≥ Deleting...');
    await apiCall('deleteCustomer', { customerId: id });
    appData.customers = appData.customers.filter(c => c.id !== id);
    selectedCustomerId = null;
    setSyncStatus('ok', '‚úÖ Synced');
    showToast('Customer deleted', 'ok');
    renderSidebar();
    renderMain();
  } catch(e) {
    setSyncStatus('err', '‚ùå Delete failed');
    showToast('Delete failed: ' + e.message, 'err');
  }
}

// SERVICE VISIT
function openAddService(customerId) {
  openModal(`
    <h3>üîß Log Service Visit</h3>
    <div class="form-row">
      <div class="form-group"><label>Visit Date *</label><input class="form-input" id="s_date" type="date" value="${todayStr()}"></div>
      <div class="form-group"><label>Visit Type</label>
        <select class="form-select" id="s_type">
          <option value="free">Free Service</option>
          <option value="complaint">Complaint Visit</option>
          <option value="paid">Paid (Extra)</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Components Replaced</label>
      <div class="comp-rows" id="compRows">
        <div class="comp-row">
          <input class="form-input" placeholder="Component name (e.g. Sediment Filter)" data-comp-name>
          <input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price>
          <button class="remove-comp-btn" onclick="removeCompRow(this)">√ó</button>
        </div>
      </div>
      <button class="add-comp-link" onclick="addCompRow()">+ Add another component</button>
    </div>
    <div class="form-group"><label>Notes / Complaint Description</label><input class="form-input" id="s_notes" placeholder="e.g. Low water pressure complaint"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveServiceBtn" onclick="saveService(${customerId})">Save Visit</button>
    </div>`);
}

function addCompRow() {
  const row = document.createElement('div');
  row.className = 'comp-row';
  row.innerHTML = `<input class="form-input" placeholder="Component name" data-comp-name><input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price><button class="remove-comp-btn" onclick="removeCompRow(this)">√ó</button>`;
  document.getElementById('compRows').appendChild(row);
}
function removeCompRow(btn) {
  const rows = document.getElementById('compRows');
  if (rows.children.length > 1) btn.closest('.comp-row').remove();
}

async function saveService(customerId) {
  const date = document.getElementById('s_date').value;
  if (!date) { alert('Date is required'); return; }

  const btn = document.getElementById('saveServiceBtn');
  btn.disabled = true; btn.textContent = 'Saving...';

  const type = document.getElementById('s_type').value;
  const notes = document.getElementById('s_notes').value.trim();
  const names = document.querySelectorAll('[data-comp-name]');
  const prices = document.querySelectorAll('[data-comp-price]');
  const components = [];
  names.forEach((inp, i) => {
    const name = inp.value.trim();
    if (name) components.push({ name, price: Number(prices[i]?.value || 0) });
  });

  const service = { id: uid(), date, type, notes, components };

  try {
    setSyncStatus('loading', '‚è≥ Saving...');
    await apiCall('saveService', { customerId, service });

    const customer = appData.customers.find(c => c.id === customerId);
    if (!customer.services) customer.services = [];
    customer.services.push(service);

    setSyncStatus('ok', '‚úÖ Synced');
    showToast('‚úÖ Service visit saved to Google Sheets', 'profit');
    closeModal();
    renderMain();
  } catch(e) {
    setSyncStatus('err', '‚ùå Save failed');
    showToast('Save failed: ' + e.message, 'err');
    btn.disabled = false; btn.textContent = 'Save Visit';
  }
}

async function deleteService(customerId, serviceId) {
  if (!confirm('Remove this service visit?')) return;
  try {
    setSyncStatus('loading', '‚è≥ Deleting...');
    await apiCall('deleteService', { customerId, serviceId });
    const customer = appData.customers.find(c => c.id === customerId);
    customer.services = customer.services.filter(s => s.id !== serviceId);
    setSyncStatus('ok', '‚úÖ Synced');
    showToast('Service visit deleted', 'ok');
    renderMain();
  } catch(e) {
    setSyncStatus('err', '‚ùå Delete failed');
    showToast('Delete failed: ' + e.message, 'err');
  }
}
</script>
</body>
</html>
