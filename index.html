<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaTrack ‚Äî RO Filter AMC Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e; --surface: #111827; --surface2: #1a2235; --border: #1f2d47;
    --accent: #00d4ff; --profit: #22d3a5; --loss: #f87171; --warn: #fbbf24;
    --text: #e2e8f0; --text-dim: #64748b; --text-mid: #94a3b8;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

  /* SETUP */
  .setup-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
  .setup-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:40px; width:100%; max-width:540px; }
  .setup-card h1 { font-family:'Syne',sans-serif; font-weight:800; font-size:28px; color:var(--accent); margin-bottom:6px; }
  .setup-card p { color:var(--text-mid); font-size:14px; margin-bottom:28px; }
  .setup-step { display:flex; gap:14px; align-items:flex-start; padding:12px 0; border-bottom:1px solid var(--border); }
  .setup-step:last-child { border-bottom:none; }
  .step-num { width:28px; height:28px; border-radius:50%; background:var(--accent); color:#000; font-family:'Syne',sans-serif; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .step-text { font-size:13px; color:var(--text-mid); line-height:1.6; }
  .step-text strong { color:var(--text); }
  .step-text a { color:var(--accent); }
  .url-input-wrap { margin-top:20px; }
  .url-input-wrap label { display:block; font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); margin-bottom:8px; }
  .url-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px 14px; color:var(--text); font-family:'DM Mono',monospace; font-size:12px; outline:none; transition:border-color 0.2s; }
  .url-input:focus { border-color:var(--accent); }
  .connect-btn { width:100%; margin-top:14px; background:var(--accent); color:#000; border:none; border-radius:8px; padding:12px; font-family:'Syne',sans-serif; font-weight:700; font-size:14px; cursor:pointer; }
  .connect-btn:disabled { opacity:0.6; cursor:not-allowed; }

  /* LAYOUT */
  #appShell { display:none; }
  header { background:linear-gradient(135deg,#0a0f1e,#0d1a2e); border-bottom:1px solid var(--border); padding:14px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
  .logo { font-family:'Syne',sans-serif; font-weight:800; font-size:20px; color:var(--accent); }
  .logo span { color:var(--text); }
  .header-right { display:flex; gap:10px; align-items:center; }
  .sync-status { font-size:11px; padding:4px 10px; border-radius:20px; }
  .sync-ok { background:rgba(34,211,165,.12); color:var(--profit); }
  .sync-err { background:rgba(248,113,113,.12); color:var(--loss); }
  .sync-loading { background:rgba(0,212,255,.1); color:var(--accent); }

  /* REMINDER BANNER */
  #reminderBanner { display:none; background:rgba(251,191,36,.07); border-bottom:1px solid rgba(251,191,36,.2); padding:10px 24px; }
  .reminder-banner-inner { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .reminder-banner-title { font-family:'Syne',sans-serif; font-weight:700; color:var(--warn); font-size:13px; }
  .reminder-chips { display:flex; gap:8px; flex-wrap:wrap; flex:1; }
  .reminder-chip { background:rgba(251,191,36,.1); border:1px solid rgba(251,191,36,.25); border-radius:20px; padding:4px 12px; font-size:12px; color:var(--warn); cursor:pointer; display:flex; align-items:center; gap:6px; white-space:nowrap; }
  .reminder-chip:hover { background:rgba(251,191,36,.18); }
  .reminder-chip .days { font-weight:700; }

  .app { display:flex; height:calc(100vh - 53px); }
  .sidebar { width:300px; min-width:240px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
  .main { flex:1; overflow-y:auto; padding:24px; }

  .sidebar-top { padding:14px; border-bottom:1px solid var(--border); }
  .search-box { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:9px 12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px; outline:none; }
  .search-box:focus { border-color:var(--accent); }
  .search-box::placeholder { color:var(--text-dim); }
  .add-customer-btn { width:100%; margin-top:10px; background:var(--accent); color:#000; border:none; border-radius:8px; padding:9px; font-family:'Syne',sans-serif; font-weight:700; font-size:13px; cursor:pointer; }

  /* FILTER TABS */
  .filter-tabs { display:flex; gap:4px; margin-top:10px; background:var(--bg); border-radius:8px; padding:3px; }
  .filter-tab { flex:1; text-align:center; padding:5px 4px; font-size:11px; font-weight:700; font-family:'Syne',sans-serif; border-radius:6px; cursor:pointer; border:none; background:none; color:var(--text-dim); letter-spacing:0.3px; transition:all 0.15s; }
  .filter-tab.active { background:var(--surface); color:var(--text); box-shadow:0 1px 4px rgba(0,0,0,0.3); }
  .filter-tab.active.all { color:var(--text); }
  .filter-tab.active.amc { color:var(--accent); }
  .filter-tab.active.regular { color:var(--profit); }

  .badge-regular { background:rgba(34,211,165,.12); color:var(--profit); }
  .badge-last-visit { background:rgba(148,163,184,.1); color:var(--text-mid); }

  .customer-list { overflow-y:auto; flex:1; }
  .customer-item { padding:13px 16px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
  .customer-item:hover { background:var(--surface2); }
  .customer-item.active { background:rgba(0,212,255,.07); border-left:3px solid var(--accent); }
  .c-name { font-family:'Syne',sans-serif; font-weight:600; font-size:14px; }
  .c-meta { font-size:12px; color:var(--text-dim); margin-top:3px; }
  .c-badges { display:flex; flex-wrap:wrap; gap:4px; margin-top:5px; }
  .c-badge { font-size:10px; font-weight:700; padding:2px 7px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; }
  .badge-active { background:rgba(34,211,165,.15); color:var(--profit); }
  .badge-expired { background:rgba(248,113,113,.15); color:var(--loss); }
  .badge-expiring { background:rgba(251,191,36,.15); color:var(--warn); }
  .badge-reminder { background:rgba(251,191,36,.2); color:var(--warn); }
  .badge-pending { background:rgba(248,113,113,.15); color:var(--loss); }

  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-dim); gap:12px; text-align:center; }
  .customer-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:24px; gap:16px; flex-wrap:wrap; }
  .customer-title h2 { font-family:'Syne',sans-serif; font-weight:800; font-size:26px; }
  .customer-title p { color:var(--text-mid); margin-top:4px; font-size:13px; }

  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:24px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px; }
  .stat-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:8px; }
  .stat-value { font-family:'Syne',sans-serif; font-weight:700; font-size:22px; }
  .stat-value.profit { color:var(--profit); } .stat-value.loss { color:var(--loss); } .stat-value.neutral { color:var(--accent); }
  .stat-sub { font-size:11px; color:var(--text-dim); margin-top:4px; }

  .section { background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:20px; overflow:hidden; }
  .section-header { padding:14px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .section-title { font-family:'Syne',sans-serif; font-weight:700; font-size:14px; }

  .btn { border:none; border-radius:7px; padding:7px 14px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:500; cursor:pointer; transition:all 0.15s; }
  .btn-accent { background:var(--accent); color:#000; font-weight:700; }
  .btn-accent:hover { background:#00b8d9; }
  .btn-accent:disabled { opacity:.5; cursor:not-allowed; }
  .btn-ghost { background:var(--surface2); color:var(--text-mid); border:1px solid var(--border); }
  .btn-ghost:hover { color:var(--text); }
  .btn-danger { background:rgba(248,113,113,.1); color:var(--loss); border:1px solid rgba(248,113,113,.2); }
  .btn-sm { padding:4px 10px; font-size:11px; }
  .btn-warn { background:rgba(251,191,36,.12); color:var(--warn); border:1px solid rgba(251,191,36,.25); }
  .btn-warn:hover { background:rgba(251,191,36,.22); }
  .btn-green { background:rgba(34,211,165,.12); color:var(--profit); border:1px solid rgba(34,211,165,.25); }
  .btn-green:hover { background:rgba(34,211,165,.22); }

  /* SERVICE TABLE */
  .service-table { width:100%; border-collapse:collapse; }
  .service-table th { font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); font-family:'DM Mono',monospace; padding:10px 18px; text-align:left; border-bottom:1px solid var(--border); font-weight:500; }
  .service-table td { padding:11px 18px; border-bottom:1px solid rgba(31,45,71,.5); font-size:13px; vertical-align:middle; }
  .service-table tr:last-child td { border-bottom:none; }
  .service-table tr:hover td { background:rgba(255,255,255,.02); }

  /* PENDING ROW ‚Äî subtle red left border + tint */
  .row-pending td:first-child { border-left:3px solid var(--loss); }
  .row-pending { background:rgba(248,113,113,.03); }

  .service-type { font-size:10px; font-weight:700; padding:2px 8px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; }
  .type-free { background:rgba(34,211,165,.12); color:var(--profit); }
  .type-complaint { background:rgba(251,191,36,.12); color:var(--warn); }
  .type-paid { background:rgba(248,113,113,.12); color:var(--loss); }
  .type-purchase { background:rgba(0,212,255,.1); color:var(--accent); }
  .amount-cell { font-family:'DM Mono',monospace; font-weight:500; }

  /* COMPLAINT STATUS BADGES */
  .status-pending { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; background:rgba(248,113,113,.15); color:var(--loss); white-space:nowrap; }
  .status-done { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; background:rgba(34,211,165,.12); color:var(--profit); white-space:nowrap; }

  .comp-chips { display:flex; flex-wrap:wrap; gap:6px; }
  .comp-chip { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:3px 9px; font-size:12px; color:var(--text-mid); display:flex; align-items:center; gap:5px; }
  .comp-chip .price { font-family:'DM Mono',monospace; font-size:11px; color:var(--accent); }

  /* ROW ACTION BUTTONS */
  .row-actions { display:flex; gap:4px; align-items:center; white-space:nowrap; }
  .icon-btn { background:none; border:1px solid transparent; cursor:pointer; font-size:13px; padding:4px 7px; border-radius:6px; transition:all 0.15s; opacity:0.5; }
  .icon-btn:hover { opacity:1; border-color:var(--border); background:var(--surface2); }
  .icon-btn.edit:hover { color:var(--accent); border-color:rgba(0,212,255,.3); }
  .icon-btn.del:hover { color:var(--loss); border-color:rgba(248,113,113,.3); }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:28px; width:100%; max-width:560px; max-height:90vh; overflow-y:auto; }
  .modal h3 { font-family:'Syne',sans-serif; font-weight:800; font-size:18px; margin-bottom:20px; color:var(--accent); }
  .form-group { margin-bottom:14px; }
  .form-group label { display:block; font-size:11px; text-transform:uppercase; letter-spacing:0.7px; color:var(--text-dim); margin-bottom:6px; font-weight:500; }
  .form-input, .form-select { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px; outline:none; transition:border-color 0.2s; }
  .form-input:focus, .form-select:focus { border-color:var(--accent); }
  .form-select option { background:var(--surface2); }
  .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }

  .comp-rows { display:flex; flex-direction:column; gap:8px; margin-bottom:8px; }
  .comp-row { display:flex; gap:8px; align-items:center; }
  .comp-row .form-input { flex:1; }
  .comp-row .price-input { width:110px; min-width:110px; }
  .remove-comp-btn { background:none; border:none; color:var(--loss); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; }

  /* STATUS TOGGLE IN MODAL */
  .status-toggle { display:flex; gap:8px; }
  .status-opt { flex:1; padding:9px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text-dim); font-size:12px; font-weight:700; cursor:pointer; text-align:center; transition:all 0.15s; }
  .status-opt.selected-pending { border-color:var(--loss); background:rgba(248,113,113,.12); color:var(--loss); }
  .status-opt.selected-done { border-color:var(--profit); background:rgba(34,211,165,.12); color:var(--profit); }

  .no-data { padding:28px; text-align:center; color:var(--text-dim); font-size:13px; }
  .progress-bar-wrap { height:6px; background:var(--border); border-radius:3px; margin-top:8px; overflow:hidden; }
  .progress-bar { height:100%; border-radius:3px; }
  .amc-info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; padding:16px 18px; }
  .amc-info-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.6px; }
  .amc-info-value { font-family:'DM Mono',monospace; font-size:14px; margin-top:4px; }

  .spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(0,212,255,.2); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; margin-right:6px; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .toast { position:fixed; bottom:24px; right:24px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 18px; font-size:13px; z-index:999; box-shadow:0 8px 30px rgba(0,0,0,.4); animation:slideUp 0.3s ease; }
  @keyframes slideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
  @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} }
  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:var(--surface); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  @media (max-width:900px) {
    .stats-row { grid-template-columns:repeat(2,1fr); }
    .amc-info-grid { grid-template-columns:repeat(2,1fr); }
  }

  @media (max-width:650px) {
    /* Layout: sidebar on top, main below */
    .app { flex-direction:column; height:auto; min-height:calc(100vh - 53px); }

    /* Sidebar: fixed compact height, full width, scrollable list */
    .sidebar { width:100%; height:auto; min-height:0; max-height:none; flex-shrink:0; border-right:none; border-bottom:1px solid var(--border); }
    .sidebar-top { padding:10px 12px; }
    .customer-list { max-height:200px; overflow-y:auto; }

    /* Customer items more compact */
    .customer-item { padding:10px 12px; }
    .c-name { font-size:13px; }

    /* Main panel scrolls */
    .main { flex:1; overflow-y:auto; padding:14px; min-height:0; }

    /* Stats grid */
    .stats-row { grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
    .stat-card { padding:12px; }
    .stat-value { font-size:18px; }

    /* AMC info grid */
    .amc-info-grid { grid-template-columns:1fr 1fr; }

    /* Form rows stack */
    .form-row { grid-template-columns:1fr; }

    /* Modal full screen on mobile */
    .modal-overlay { padding:0; align-items:flex-end; }
    .modal { border-radius:16px 16px 0 0; max-height:92vh; }

    /* TABLE: make it horizontally scrollable */
    .section { overflow:visible; }
    .table-scroll-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .service-table { min-width:560px; }
    .service-table td, .service-table th { padding:9px 12px; font-size:12px; }

    /* Hide less important columns on very small screens */
    .service-table .col-notes { display:none; }

    /* Customer header wraps nicely */
    .customer-header { margin-bottom:16px; }
    .customer-title h2 { font-size:20px; }

    /* Filter tabs */
    .filter-tab { font-size:10px; padding:4px 2px; }

    /* Add button full width */
    .add-customer-btn { font-size:12px; padding:8px; }
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="setup-screen" id="loginScreen">
  <div class="setup-card" style="max-width:400px;">
    <h1 style="text-align:center;margin-bottom:4px;">üíß AquaTrack</h1>
    <p style="text-align:center;margin-bottom:28px;">Admin Login</p>
    <div class="form-group">
      <label style="font-size:11px;text-transform:uppercase;letter-spacing:0.7px;color:var(--text-dim);display:block;margin-bottom:6px;">Username</label>
      <input class="url-input" id="loginUser" type="text" placeholder="Enter username" autocomplete="username"
        onkeydown="if(event.key==='Enter')document.getElementById('loginPass').focus()">
    </div>
    <div class="form-group" style="margin-top:12px;">
      <label style="font-size:11px;text-transform:uppercase;letter-spacing:0.7px;color:var(--text-dim);display:block;margin-bottom:6px;">Password</label>
      <div style="position:relative;">
        <input class="url-input" id="loginPass" type="password" placeholder="Enter password" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doLogin()" style="padding-right:44px;">
        <button onclick="togglePassVis()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:14px;" id="eyeBtn">üëÅÔ∏è</button>
      </div>
    </div>
    <div id="loginError" style="color:var(--loss);font-size:12px;margin-top:10px;display:none;padding:8px 12px;background:rgba(248,113,113,.08);border-radius:6px;border:1px solid rgba(248,113,113,.2);"></div>
    <button class="connect-btn" id="loginBtn" onclick="doLogin()" style="margin-top:18px;">üîê Login</button>
    <p style="text-align:center;font-size:11px;color:var(--text-dim);margin-top:16px;">AquaTrack ¬∑ RO Filter AMC Manager</p>
  </div>
</div>

<!-- MAIN APP -->
<div id="appShell">
  <header>
    <div class="logo">Aqua<span>Track</span></div>
    <div class="header-right">
      <span class="sync-status sync-ok" id="syncStatus">‚úÖ Synced</span>
      <button class="btn btn-ghost" onclick="refreshData()" style="font-size:11px;">‚ü≥ Refresh</button>
      <button class="btn btn-ghost" onclick="doLogout()" style="font-size:11px;">üîí Logout</button>
    </div>
  </header>

  <div id="reminderBanner">
    <div class="reminder-banner-inner">
      <span class="reminder-banner-title">‚ö†Ô∏è AMC Expiring Soon:</span>
      <div class="reminder-chips" id="reminderChips"></div>
    </div>
  </div>

  <div class="app">
    <div class="sidebar">
      <div class="sidebar-top">
        <input class="search-box" id="searchInput" type="text" placeholder="üîç  Search customer...">
        <button class="add-customer-btn" onclick="openAddCustomer()">+ Add New Customer</button>
        <div class="filter-tabs">
          <button class="filter-tab active all" onclick="setFilter('all',this)">All</button>
          <button class="filter-tab amc" onclick="setFilter('amc',this)">üîµ AMC</button>
          <button class="filter-tab regular" onclick="setFilter('regular',this)">üü¢ Regular</button>
        </div>
      </div>
      <div class="customer-list" id="customerList">
        <div class="no-data"><span class="spinner"></span> Loading...</div>
      </div>
    </div>
    <div class="main" id="mainContent">
      <div class="empty-state">
        <div style="font-size:48px;opacity:0.3;">üíß</div>
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div>
        <div style="max-width:260px;color:var(--text-dim);font-size:13px;">Choose a customer from the sidebar to view their AMC ledger.</div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay" style="display:none;" onclick="handleOverlayClick(event)">
  <div class="modal" id="modalBox"></div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Only the Script URL lives here ‚Äî credentials are in Apps Script
const SCRIPT_URL  = 'YOUR_APPS_SCRIPT_URL_HERE'; // ‚Üê Paste your Web App URL
const TOKEN_KEY   = 'aquatrack_token';
const TOKEN_EXP   = 'aquatrack_token_exp';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let appData = { customers: [], nextId: 1 };
let selectedCustomerId = null;
let activeFilter = 'all';
let SESSION_TOKEN = localStorage.getItem(TOKEN_KEY) || null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => {
  const token = localStorage.getItem(TOKEN_KEY);
  const exp   = localStorage.getItem(TOKEN_EXP);
  if (token && exp && Date.now() < parseInt(exp)) {
    SESSION_TOKEN = token;
    showApp();
    refreshData();
  } else {
    clearSession();
    document.getElementById('loginScreen').style.display = 'flex';
  }
};

function clearSession() {
  SESSION_TOKEN = null;
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(TOKEN_EXP);
}

function togglePassVis() {
  const inp = document.getElementById('loginPass');
  const btn = document.getElementById('eyeBtn');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅÔ∏è'; }
}

async function doLogin() {
  const user  = document.getElementById('loginUser').value.trim();
  const pass  = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  const btn   = document.getElementById('loginBtn');
  if (!user || !pass) { errEl.textContent = '‚ö†Ô∏è Please enter username and password.'; errEl.style.display = 'block'; return; }

  btn.disabled = true; btn.textContent = '‚è≥ Verifying...';
  errEl.style.display = 'none';

  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'login', username: user, password: pass }),
      headers: { 'Content-Type': 'text/plain' }
    });
    const data = await res.json();

    if (data.success && data.token) {
      SESSION_TOKEN = data.token;
      localStorage.setItem(TOKEN_KEY, data.token);
      // Store expiry time in ms
      localStorage.setItem(TOKEN_EXP, String(Date.now() + data.expiresIn * 1000));
      showApp();
      refreshData();
    } else {
      errEl.textContent = '‚ùå Incorrect username or password.';
      errEl.style.display = 'block';
      document.getElementById('loginPass').value = '';
      document.getElementById('loginPass').focus();
      const card = document.querySelector('.setup-card');
      card.style.animation = 'shake 0.4s ease';
      setTimeout(() => card.style.animation = '', 400);
    }
  } catch(e) {
    errEl.textContent = '‚ùå Could not reach server. Check your connection.';
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'üîê Login';
  }
}

async function doLogout() {
  if (!confirm('Log out of AquaTrack?')) return;
  // Tell server to invalidate the token
  try { await apiCall('logout'); } catch(e) {}
  clearSession();
  appData = { customers:[], nextId:1 }; selectedCustomerId = null;
  document.getElementById('appShell').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginError').style.display = 'none';
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';
}

function setFilter(type, btn) {
  activeFilter = type;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  selectedCustomerId = null;
  renderSidebar();
  document.getElementById('mainContent').innerHTML = `<div class="empty-state"><div style="font-size:48px;opacity:0.3;">üíß</div><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div></div>`;
}

async function refreshData() {
  setSyncStatus('loading', '‚è≥ Syncing...');
  try {
    appData = await apiCall('getAll');
    renderSidebar(); renderReminderBanner();
    if (selectedCustomerId) renderMain();
    setSyncStatus('ok', '‚úÖ Synced');
  } catch(e) { setSyncStatus('err', '‚ùå Sync failed'); }
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiCall(action, body = {}) {
  const response = await fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action, token: SESSION_TOKEN, ...body }),
    headers: { 'Content-Type': 'text/plain' }
  });
  if (!response.ok) throw new Error('HTTP ' + response.status);
  const data = await response.json();
  if (data.error === 'UNAUTHORIZED') {
    // Token expired or invalid ‚Äî force logout
    clearSession();
    appData = { customers:[], nextId:1 }; selectedCustomerId = null;
    document.getElementById('appShell').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('loginError').textContent = '‚ö†Ô∏è Session expired. Please log in again.';
    document.getElementById('loginError').style.display = 'block';
    throw new Error('Session expired');
  }
  if (data.error) throw new Error(data.error);
  return data;
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n) { return '‚Çπ' + Number(n).toLocaleString('en-IN', {minimumFractionDigits:0, maximumFractionDigits:2}); }
function fmtDate(d) { if (!d) return '‚Äî'; return new Date(d).toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'}); }
function daysBetween(a, b) { return Math.round((new Date(b) - new Date(a)) / 86400000); }
function todayStr() { return new Date().toISOString().split('T')[0]; }
function addYears(d, y) { const dt = new Date(d); dt.setFullYear(dt.getFullYear()+y); return dt.toISOString().split('T')[0]; }
function uid() { return 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); }
function amcStatus(c) {
  if (!c.amcEnd) return 'active';
  if (todayStr() > c.amcEnd) return 'expired';
  if (daysBetween(todayStr(), c.amcEnd) <= 30) return 'expiring';
  return 'active';
}
function totalComponentCost(c) {
  return (c.services||[]).reduce((s,sv) => s + (sv.components||[]).reduce((s2,co) => s2+(Number(co.price)||0),0), 0);
}
function setSyncStatus(type, text) {
  const el = document.getElementById('syncStatus');
  el.className = 'sync-status sync-' + type; el.textContent = text;
}
function showToast(msg) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ‚îÄ‚îÄ REMINDER BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReminderBanner() {
  const banner = document.getElementById('reminderBanner');
  const chips = document.getElementById('reminderChips');
  const expiring = [];
  (appData.customers||[]).forEach(c => {
    if (c.customerType === 'regular' || !c.amcEnd) return;
    const days = daysBetween(todayStr(), c.amcEnd);
    if (days >= 0 && days <= 7) expiring.push({ c, days });
  });
  if (!expiring.length) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';
  chips.innerHTML = expiring.map(({c, days}) => {
    const label = days === 0 ? 'TODAY' : `in ${days}d`;
    return `<span class="reminder-chip" onclick="selectCustomer(${c.id})">
      <span>${c.name}</span><span>¬∑</span>
      <span>AMC ends ${fmtDate(c.amcEnd)}</span>
      <span class="days">‚è∞ ${label}</span>
    </span>`;
  }).join('');
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSidebar() {
  const q = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const list = document.getElementById('customerList');
  let filtered = (appData.customers||[]).filter(c =>
    c.name.toLowerCase().includes(q)||(c.phone||'').includes(q)||(c.address||'').toLowerCase().includes(q)
  );
  if (activeFilter === 'amc') filtered = filtered.filter(c => c.customerType !== 'regular');
  if (activeFilter === 'regular') filtered = filtered.filter(c => c.customerType === 'regular');
  if (!filtered.length) { list.innerHTML = `<div class="no-data">${appData.customers.length===0?'No customers yet.':'No results.'}</div>`; return; }

  list.innerHTML = filtered.map(c => {
    if (c.customerType === 'regular') {
      const visits = c.services||[];
      const lastVisit = visits.length ? [...visits].sort((a,b)=>new Date(b.date)-new Date(a.date))[0].date : null;
      const pendingCount = visits.filter(v => v.type==='complaint' && v.status!=='done').length;
      return `<div class="customer-item ${selectedCustomerId===c.id?'active':''}" onclick="selectCustomer(${c.id})">
        <div class="c-name">${c.name}</div>
        <div class="c-meta">${c.phone?'üìû '+c.phone:''}</div>
        <div class="c-badges">
          <span class="c-badge badge-regular">üü¢ Regular</span>
          ${lastVisit?`<span class="c-badge badge-last-visit">Last: ${fmtDate(lastVisit)}</span>`:''}
          ${pendingCount?`<span class="c-badge badge-pending">üî¥ ${pendingCount} Pending</span>`:''}
        </div>
      </div>`;
    }
    const st = amcStatus(c);
    const badgeClass = st==='active'?'badge-active':st==='expired'?'badge-expired':'badge-expiring';
    const daysLeft = c.amcEnd ? Math.max(0, daysBetween(todayStr(), c.amcEnd)) : null;
    const badgeText = st==='expiring'?`Expiring in ${daysLeft}d`:st.charAt(0).toUpperCase()+st.slice(1);
    const pendingCount = (c.services||[]).filter(s => s.type==='complaint' && s.status!=='done').length;
    return `<div class="customer-item ${selectedCustomerId===c.id?'active':''}" onclick="selectCustomer(${c.id})">
      <div class="c-name">${c.name}</div>
      <div class="c-meta">${c.phone?'üìû '+c.phone:''}</div>
      <div class="c-badges">
        <span class="c-badge" style="background:rgba(0,212,255,.1);color:var(--accent);">üîµ AMC</span>
        <span class="c-badge ${badgeClass}">${badgeText}</span>
        ${pendingCount?`<span class="c-badge badge-pending">üî¥ ${pendingCount} Pending</span>`:''}
      </div>
    </div>`;
  }).join('');
}
document.addEventListener('input', e => { if (e.target.id==='searchInput') renderSidebar(); });

// ‚îÄ‚îÄ MAIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectCustomer(id) {
  selectedCustomerId = id;
  renderSidebar(); renderMain();
  document.getElementById('mainContent').scrollTo(0,0);
}

// Builds the service/purchase table rows (shared between AMC + Regular)
function buildServiceRows(services, customerId, isRegular) {
  return [...services].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(s => {
    const sCost = (s.components||[]).reduce((sum,co)=>sum+(Number(co.price)||0),0);
    const isComplaint = s.type === 'complaint';
    const isPending = isComplaint && s.status !== 'done';

    // Type badge
    const typeClass = s.type==='free'?'type-free':s.type==='complaint'?'type-complaint':s.type==='purchase'?'type-purchase':'type-paid';
    const typeLabel = s.type==='free'?'Free Service':s.type==='complaint'?'Complaint':s.type==='purchase'?'Purchase':'Paid';

    // Status badge ‚Äî only show for complaints
    const statusHtml = isComplaint
      ? (isPending
          ? `<span class="status-pending">üî¥ Pending</span>`
          : `<span class="status-done">‚úÖ Done</span>`)
      : `<span style="color:var(--text-dim);font-size:11px;">‚Äî</span>`;

    return `<tr class="${isPending?'row-pending':''}">
      <td style="white-space:nowrap;">${fmtDate(s.date)}</td>
      <td><span class="service-type ${typeClass}">${typeLabel}</span></td>
      <td>${statusHtml}</td>
      <td><div class="comp-chips">
        ${(s.components||[]).map(co=>`<span class="comp-chip">${co.name} <span class="price">${fmt(co.price)}</span></span>`).join('')}
        ${!(s.components||[]).length?'<span style="color:var(--text-dim);font-size:12px;">None yet</span>':''}
      </div></td>
      <td class="amount-cell">${sCost>0?fmt(sCost):'‚Äî'}</td>
      <td class="col-notes" style="color:var(--text-dim);font-size:12px;max-width:130px;">${s.notes||'‚Äî'}</td>
      <td><div class="row-actions">
        <button class="icon-btn edit" title="Edit entry" onclick="openEditService(${customerId},'${s.id}')">‚úèÔ∏è</button>
        <button class="icon-btn del" title="Delete entry" onclick="deleteService(${customerId},'${s.id}')">üóëÔ∏è</button>
      </div></td>
    </tr>`;
  }).join('');
}

function renderMain() {
  const c = appData.customers.find(x => x.id===selectedCustomerId);
  const main = document.getElementById('mainContent');
  if (!c) { main.innerHTML = `<div class="empty-state"><div style="font-size:48px;opacity:0.3;">üíß</div><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--text-mid);">Select a Customer</div></div>`; return; }
  if (c.customerType === 'regular') { renderRegularMain(c); return; }

  const totalCost = totalComponentCost(c);
  const amcAmt = Number(c.amcAmount)||0;
  const profit = amcAmt - totalCost;
  const st = amcStatus(c);
  let progressPct=0, daysLeft=0, totalDays=365;
  if (c.amcStart && c.amcEnd) {
    totalDays = daysBetween(c.amcStart, c.amcEnd);
    progressPct = Math.min(100, Math.max(0, Math.round((daysBetween(c.amcStart,todayStr())/totalDays)*100)));
    daysLeft = Math.max(0, daysBetween(todayStr(), c.amcEnd));
  }
  const progressColor = st==='expired'?'var(--loss)':st==='expiring'?'var(--warn)':'var(--accent)';

  const servicesHtml = !(c.services||[]).length
    ? `<div class="no-data">No service visits logged yet. Click "+ Log Service Visit" to add one.</div>`
    : `<div class="table-scroll-wrap"><table class="service-table">
        <thead><tr><th>Date</th><th>Type</th><th>Status</th><th>Components Replaced</th><th>Cost</th><th class="col-notes">Notes</th><th></th></tr></thead>
        <tbody>${buildServiceRows(c.services, c.id, false)}</tbody>
      </table></div>`;

  main.innerHTML = `
    <div class="customer-header">
      <div class="customer-title">
        <h2>üìã ${c.name}</h2>
        <p>${c.phone?'üìû '+c.phone:''} ${c.address?'  üìç '+c.address:''}</p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-accent" onclick="openAddService(${c.id})">+ Log Service Visit</button>
        <button class="btn btn-ghost" onclick="openEditCustomer(${c.id})">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">AMC Amount</div><div class="stat-value neutral">${fmt(amcAmt)}</div><div class="stat-sub">${totalDays} day contract</div></div>
      <div class="stat-card"><div class="stat-label">Components Cost</div><div class="stat-value" style="color:var(--text);">${fmt(totalCost)}</div><div class="stat-sub">${(c.services||[]).length} visit(s)</div></div>
      <div class="stat-card"><div class="stat-label">${profit>=0?'‚úÖ Profit':'‚ùå Loss'}</div><div class="stat-value ${profit>=0?'profit':'loss'}">${fmt(Math.abs(profit))}</div><div class="stat-sub">${profit>=0?'You\'re in profit':'You\'re in loss'}</div></div>
      <div class="stat-card">
        <div class="stat-label">AMC Status</div>
        <div class="stat-value" style="color:${progressColor};font-size:16px;">${st==='expired'?'Expired':daysLeft+' days left'+(st==='expiring'?' ‚ö†Ô∏è':'')}</div>
        <div class="progress-bar-wrap"><div class="progress-bar" style="width:${progressPct}%;background:${progressColor};"></div></div>
        <div class="stat-sub">${progressPct}% elapsed</div>
      </div>
    </div>
    <div class="section">
      <div class="section-header"><span class="section-title">AMC Details</span></div>
      <div class="amc-info-grid">
        <div><div class="amc-info-label">Start Date</div><div class="amc-info-value">${fmtDate(c.amcStart)}</div></div>
        <div><div class="amc-info-label">End Date</div><div class="amc-info-value">${fmtDate(c.amcEnd)}</div></div>
        <div><div class="amc-info-label">RO Model</div><div class="amc-info-value">${c.roModel||'‚Äî'}</div></div>
        <div><div class="amc-info-label">Notes</div><div class="amc-info-value" style="font-family:'DM Sans';font-size:12px;">${c.notes||'‚Äî'}</div></div>
      </div>
    </div>
    <div class="section">
      <div class="section-header">
        <span class="section-title">üîß Service Visit Ledger</span>
        <button class="btn btn-accent btn-sm" onclick="openAddService(${c.id})">+ Log Visit</button>
      </div>
      ${servicesHtml}
    </div>`;
}

// ‚îÄ‚îÄ REGULAR CUSTOMER VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRegularMain(c) {
  const main = document.getElementById('mainContent');
  const visits = c.services||[];
  const totalSpent = visits.reduce((sum,v)=>sum+(v.components||[]).reduce((s2,co)=>s2+(Number(co.price)||0),0),0);
  const lastVisit = visits.length ? [...visits].sort((a,b)=>new Date(b.date)-new Date(a.date))[0] : null;

  const historyHtml = !visits.length
    ? `<div class="no-data">No history yet. Click "+ Log Purchase / Complaint" to add one.</div>`
    : `<div class="table-scroll-wrap"><table class="service-table">
        <thead><tr><th>Date</th><th>Type</th><th>Status</th><th>Items</th><th>Amount</th><th class="col-notes">Notes</th><th></th></tr></thead>
        <tbody>${buildServiceRows(visits, c.id, true)}</tbody>
      </table></div>`;

  main.innerHTML = `
    <div class="customer-header">
      <div class="customer-title">
        <h2>üü¢ ${c.name}</h2>
        <p>${c.phone?'üìû '+c.phone:''} ${c.address?'  üìç '+c.address:''}</p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-accent" onclick="openAddRegularVisit(${c.id})">+ Log Purchase / Complaint</button>
        <button class="btn btn-ghost" onclick="openEditCustomer(${c.id})">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
      </div>
    </div>
    <div class="stats-row" style="grid-template-columns:repeat(3,1fr);">
      <div class="stat-card"><div class="stat-label">Total Visits</div><div class="stat-value neutral">${visits.length}</div><div class="stat-sub">On record</div></div>
      <div class="stat-card"><div class="stat-label">Total Spent</div><div class="stat-value" style="color:var(--text);">${fmt(totalSpent)}</div><div class="stat-sub">Across all visits</div></div>
      <div class="stat-card"><div class="stat-label">Last Visit</div><div class="stat-value" style="font-size:16px;color:var(--profit);">${lastVisit?fmtDate(lastVisit.date):'‚Äî'}</div><div class="stat-sub">${lastVisit?daysBetween(lastVisit.date,todayStr())+' days ago':'No visits yet'}</div></div>
    </div>
    <div class="section">
      <div class="section-header"><span class="section-title">‚ÑπÔ∏è Customer Info</span></div>
      <div class="amc-info-grid" style="grid-template-columns:repeat(3,1fr);">
        <div><div class="amc-info-label">RO Model</div><div class="amc-info-value">${c.roModel||'‚Äî'}</div></div>
        <div><div class="amc-info-label">Type</div><div class="amc-info-value" style="font-family:'DM Sans';color:var(--profit);">üü¢ Regular (No AMC)</div></div>
        <div><div class="amc-info-label">Notes</div><div class="amc-info-value" style="font-family:'DM Sans';font-size:12px;">${c.notes||'‚Äî'}</div></div>
      </div>
    </div>
    <div class="section">
      <div class="section-header">
        <span class="section-title">üõí Purchase & Complaint History</span>
        <button class="btn btn-accent btn-sm" onclick="openAddRegularVisit(${c.id})">+ Log Entry</button>
      </div>
      ${historyHtml}
    </div>`;
}

// ‚îÄ‚îÄ SERVICE MODAL (Add + Edit, shared) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function serviceModalHtml({ customerId, isRegular, existing }) {
  const isEdit = !!existing;
  const s = existing || {};
  const currentType = s.type || (isRegular ? 'purchase' : 'free');
  const currentStatus = s.status || 'pending';
  const showStatus = currentType === 'complaint';

  // Build component rows ‚Äî always at least one empty row when adding
  const comps = (s.components && s.components.length) ? s.components : [{ name:'', price:'' }];
  const compRowsHtml = comps.map(co => `
    <div class="comp-row">
      <input class="form-input" placeholder="${isRegular?'Item name':'Component name'}" data-comp-name value="${co.name||''}">
      <input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price value="${co.price||''}">
      <button class="remove-comp-btn" onclick="this.closest('.comp-row').remove()">√ó</button>
    </div>`).join('');

  const typeOptions = isRegular
    ? `<option value="purchase" ${currentType==='purchase'?'selected':''}>üõí Purchase</option>
       <option value="complaint" ${currentType==='complaint'?'selected':''}>üîß Complaint</option>`
    : `<option value="free" ${currentType==='free'?'selected':''}>‚úÖ Free Service</option>
       <option value="complaint" ${currentType==='complaint'?'selected':''}>üîß Complaint</option>
       <option value="paid" ${currentType==='paid'?'selected':''}>üí∞ Paid (Extra)</option>`;

  return `
    <h3>${isEdit ? '‚úèÔ∏è Edit Entry' : (isRegular ? 'üõí Log Purchase / Complaint' : 'üîß Log Service Visit')}</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Date *</label>
        <input class="form-input" id="s_date" type="date" value="${s.date||todayStr()}">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select class="form-select" id="s_type" onchange="onTypeChange(this)">${typeOptions}</select>
      </div>
    </div>

    <div class="form-group" id="statusWrap" style="display:${showStatus?'block':'none'};">
      <label>Complaint Status</label>
      <div class="status-toggle">
        <button type="button" id="statusPendingBtn"
          class="status-opt ${currentStatus!=='done'?'selected-pending':''}"
          onclick="selectStatus('pending')">üî¥ Pending</button>
        <button type="button" id="statusDoneBtn"
          class="status-opt ${currentStatus==='done'?'selected-done':''}"
          onclick="selectStatus('done')">‚úÖ Done</button>
      </div>
      <input type="hidden" id="s_status" value="${currentStatus}">
    </div>

    <div class="form-group">
      <label>${isRegular ? 'Items Purchased' : 'Components Replaced'}</label>
      <div class="comp-rows" id="compRows">${compRowsHtml}</div>
      <button style="color:var(--accent);font-size:12px;cursor:pointer;background:none;border:none;text-decoration:underline;font-family:'DM Sans',sans-serif;margin-top:4px;" onclick="addCompRow()">+ Add ${isRegular?'item':'component'}</button>
    </div>

    <div class="form-group">
      <label>Notes</label>
      <input class="form-input" id="s_notes" value="${s.notes||''}" placeholder="${isRegular?'e.g. Customer had a taste issue':'e.g. Low pressure complaint'}">
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveServiceBtn"
        onclick="saveServiceEntry(${customerId},'${s.id||''}')">
        ${isEdit ? 'Save Changes' : 'Save'}
      </button>
    </div>`;
}

function onTypeChange(sel) {
  document.getElementById('statusWrap').style.display = sel.value === 'complaint' ? 'block' : 'none';
}

function selectStatus(val) {
  document.getElementById('s_status').value = val;
  document.getElementById('statusPendingBtn').className = 'status-opt ' + (val==='pending'?'selected-pending':'');
  document.getElementById('statusDoneBtn').className = 'status-opt ' + (val==='done'?'selected-done':'');
}

function openAddService(customerId) {
  openModal(serviceModalHtml({ customerId, isRegular: false, existing: null }));
}
function openAddRegularVisit(customerId) {
  openModal(serviceModalHtml({ customerId, isRegular: true, existing: null }));
}
function openEditService(customerId, serviceId) {
  const c = appData.customers.find(x => x.id === customerId);
  const s = (c.services||[]).find(x => x.id === serviceId);
  const isRegular = c.customerType === 'regular';
  openModal(serviceModalHtml({ customerId, isRegular, existing: s }));
}

async function saveServiceEntry(customerId, existingId) {
  const date = document.getElementById('s_date').value;
  if (!date) { alert('Date required'); return; }
  const btn = document.getElementById('saveServiceBtn');
  btn.disabled = true; btn.textContent = 'Saving...';

  const type = document.getElementById('s_type').value;
  const status = type === 'complaint' ? document.getElementById('s_status').value : null;
  const notes = document.getElementById('s_notes').value.trim();
  const components = [];
  const nameInputs = document.querySelectorAll('[data-comp-name]');
  const priceInputs = document.querySelectorAll('[data-comp-price]');
  nameInputs.forEach((inp, i) => {
    const name = inp.value.trim();
    if (name) components.push({ name, price: Number(priceInputs[i]?.value || 0) });
  });

  const c = appData.customers.find(x => x.id === customerId);
  const isEdit = !!existingId;

  if (isEdit) {
    // Update in-place and save entire customer
    const idx = c.services.findIndex(s => s.id === existingId);
    c.services[idx] = { ...c.services[idx], date, type, status, notes, components };
    try {
      setSyncStatus('loading', '‚è≥ Saving...');
      await apiCall('saveCustomer', { customer: c });
      setSyncStatus('ok', '‚úÖ Synced');
      showToast('‚úÖ Entry updated');
      closeModal(); renderMain(); renderSidebar();
    } catch(e) {
      setSyncStatus('err', '‚ùå Error'); showToast('Error: ' + e.message);
      btn.disabled = false; btn.textContent = 'Save Changes';
    }
  } else {
    // New entry
    const service = { id: uid(), date, type, status, notes, components };
    try {
      setSyncStatus('loading', '‚è≥ Saving...');
      await apiCall('saveService', { customerId, service });
      if (!c.services) c.services = [];
      c.services.push(service);
      setSyncStatus('ok', '‚úÖ Synced');
      showToast('‚úÖ Entry saved');
      closeModal(); renderMain(); renderSidebar();
    } catch(e) {
      setSyncStatus('err', '‚ùå Error'); showToast('Error: ' + e.message);
      btn.disabled = false; btn.textContent = 'Save';
    }
  }
}

function addCompRow() {
  const row = document.createElement('div');
  row.className = 'comp-row';
  row.innerHTML = `<input class="form-input" placeholder="Name" data-comp-name><input class="form-input price-input" placeholder="Price ‚Çπ" type="number" data-comp-price><button class="remove-comp-btn" onclick="this.closest('.comp-row').remove()">√ó</button>`;
  document.getElementById('compRows').appendChild(row);
}

async function deleteService(customerId, serviceId) {
  if (!confirm('Remove this entry?')) return;
  try {
    setSyncStatus('loading', '‚è≥ Deleting...');
    await apiCall('deleteService', { customerId, serviceId });
    const c = appData.customers.find(x => x.id === customerId);
    c.services = c.services.filter(s => s.id !== serviceId);
    setSyncStatus('ok', '‚úÖ Synced');
    showToast('Entry deleted');
    renderMain(); renderSidebar();
  } catch(e) { showToast('Error: ' + e.message); }
}

// ‚îÄ‚îÄ CUSTOMER MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(html) { document.getElementById('modalBox').innerHTML = html; document.getElementById('modalOverlay').style.display = 'flex'; }
function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
function handleOverlayClick(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

function customerForm(c) {
  const isEdit = !!c;
  const isRegular = c?.customerType === 'regular';
  return `
    <h3>${isEdit ? '‚úèÔ∏è Edit Customer' : 'üë§ New Customer'}</h3>
    <div class="form-group">
      <label>Customer Type</label>
      <div style="display:flex;gap:8px;">
        <button type="button" id="typeAMC" onclick="toggleCustomerType('amc')" class="btn ${!isRegular?'btn-accent':'btn-ghost'}" style="flex:1;">üîµ AMC Customer</button>
        <button type="button" id="typeRegular" onclick="toggleCustomerType('regular')" class="btn ${isRegular?'btn-green':'btn-ghost'}" style="flex:1;">üü¢ Regular Customer</button>
      </div>
      <input type="hidden" id="f_customerType" value="${isRegular?'regular':'amc'}">
    </div>
    <div class="form-row">
      <div class="form-group"><label>Customer Name *</label><input class="form-input" id="f_name" value="${c?.name||''}" placeholder="e.g. Ramesh Kumar"></div>
      <div class="form-group"><label>Phone</label><input class="form-input" id="f_phone" value="${c?.phone||''}" placeholder="9876543210"></div>
    </div>
    <div class="form-group"><label>Address</label><input class="form-input" id="f_address" value="${c?.address||''}" placeholder="House / Area"></div>
    <div class="form-group"><label>RO Model</label><input class="form-input" id="f_roModel" value="${c?.roModel||''}" placeholder="e.g. Kent Grand Plus"></div>
    <div id="amcFields" style="display:${isRegular?'none':'block'};">
      <div class="form-group"><label>AMC Amount (‚Çπ)</label><input class="form-input" id="f_amcAmount" type="number" value="${c?.amcAmount||''}" placeholder="5000"></div>
      <div class="form-row">
        <div class="form-group"><label>AMC Start Date</label><input class="form-input" id="f_amcStart" type="date" value="${c?.amcStart||todayStr()}"></div>
        <div class="form-group"><label>AMC End Date</label><input class="form-input" id="f_amcEnd" type="date" value="${c?.amcEnd||addYears(todayStr(),1)}"></div>
      </div>
    </div>
    <div class="form-group"><label>Notes</label><input class="form-input" id="f_notes" value="${c?.notes||''}" placeholder="Any special notes..."></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="saveCustomerBtn" onclick="saveCustomer(${c?.id||'null'})">${isEdit?'Save Changes':'Add Customer'}</button>
    </div>`;
}

function toggleCustomerType(type) {
  document.getElementById('f_customerType').value = type;
  const amcBtn = document.getElementById('typeAMC');
  const regBtn = document.getElementById('typeRegular');
  if (type==='amc') {
    amcBtn.className='btn btn-accent'; amcBtn.style.flex='1';
    regBtn.className='btn btn-ghost'; regBtn.style.flex='1';
    document.getElementById('amcFields').style.display='block';
  } else {
    amcBtn.className='btn btn-ghost'; amcBtn.style.flex='1';
    regBtn.className='btn btn-green'; regBtn.style.flex='1';
    document.getElementById('amcFields').style.display='none';
  }
}

function openAddCustomer() { openModal(customerForm(null)); }
function openEditCustomer(id) { openModal(customerForm(appData.customers.find(x=>x.id===id))); }

async function saveCustomer(id) {
  const name = document.getElementById('f_name').value.trim();
  if (!name) { alert('Name required'); return; }
  const btn = document.getElementById('saveCustomerBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  const isNew = !id;
  const customerId = isNew ? appData.nextId : id;
  const existing = isNew ? null : appData.customers.find(c=>c.id===id);
  const customerType = document.getElementById('f_customerType').value;
  const isRegular = customerType === 'regular';
  const customer = {
    id: customerId, customerType, name,
    phone: document.getElementById('f_phone').value.trim(),
    address: document.getElementById('f_address').value.trim(),
    roModel: document.getElementById('f_roModel').value.trim(),
    amcAmount: isRegular ? null : document.getElementById('f_amcAmount').value,
    amcStart: isRegular ? null : document.getElementById('f_amcStart').value,
    amcEnd: isRegular ? null : document.getElementById('f_amcEnd').value,
    notes: document.getElementById('f_notes').value.trim(),
    services: existing?.services || []
  };
  try {
    setSyncStatus('loading', '‚è≥ Saving...');
    await apiCall('saveCustomer', { customer });
    if (isNew) { appData.customers.push(customer); appData.nextId++; selectedCustomerId = customerId; }
    else { const idx = appData.customers.findIndex(c=>c.id===id); appData.customers[idx] = customer; }
    setSyncStatus('ok', '‚úÖ Synced');
    showToast(isNew ? '‚úÖ Customer added' : '‚úÖ Customer updated');
    closeModal(); renderSidebar(); renderMain(); renderReminderBanner();
  } catch(e) {
    setSyncStatus('err', '‚ùå Error'); showToast('Error: ' + e.message);
    btn.disabled = false; btn.textContent = isNew ? 'Add Customer' : 'Save Changes';
  }
}

async function deleteCustomer(id) {
  if (!confirm('Delete this customer?')) return;
  try {
    setSyncStatus('loading', '‚è≥ Deleting...');
    await apiCall('deleteCustomer', { customerId: id });
    appData.customers = appData.customers.filter(c => c.id !== id);
    selectedCustomerId = null;
    setSyncStatus('ok', '‚úÖ Synced'); showToast('Customer deleted');
    renderSidebar(); renderMain(); renderReminderBanner();
  } catch(e) { showToast('Error: ' + e.message); }
}
</script>
</body>
</html>
